<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile - Vietnamese Memories</title>
  <link rel="icon" type="image/png" href="../logo.PNG" />
  <link rel="stylesheet" href="../style.css" />
  <style>
    /* Cải tiến giao diện profile header */
    .profile-header {
      background: linear-gradient(135deg, rgba(94, 53, 177, 0.9), rgba(103, 58, 183, 0.85));
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .profile-header-content {
      display: flex;
      align-items: flex-start;
    }

    .profile-avatar {
      position: relative;
      margin-right: 15px;
    }

    .profile-avatar img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .change-avatar-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }

    .profile-info {
      flex: 1;
    }

    .profile-info-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .username-container {
      display: flex;
      align-items: center;
    }

    .profile-info h2 {
      margin: 0;
      color: white;
      font-size: 24px;
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
    }

    .profile-points {
      color: rgba(255, 255, 255, 0.9);
      font-size: 16px;
      margin: 2px 0 8px 10px;
    }

    .profile-info p {
      margin: 5px 0 0 10px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
    }

    .edit-profile-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 35px;
      height: 35px;
      min-width: 35px; /* Đảm bảo không bị co lại */
      cursor: pointer;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
      margin-left: 10px;
    }

    .edit-profile-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    /* Style cho nút lưu khi đang chỉnh sửa */
    .edit-mode .edit-profile-btn {
      background: rgba(46, 204, 113, 0.7);
      border-color: rgba(46, 204, 113, 0.8);
    }
    
    .edit-mode .edit-profile-btn:hover {
      background: rgba(46, 204, 113, 0.9);
    }

    /* Ẩn header ở trên */
    .user-header {
      display: none !important;
    }
    
    /* Style cho chế độ chỉnh sửa */
    .profile-input {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 6px;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    
    #bioInput {
      min-height: 80px;
      resize: vertical;
    }
    
    .username-history-container {
      margin: 10px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: white;
      font-size: 14px;
    }


    
    /* Username container styling */
    .username-container {
      display: flex;
      align-items: center;
      position: relative;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- User Header -->
    <div class="user-header" id="userHeader">
      <!-- User logged in state -->
      <div id="userLoggedIn" class="user-logged-in" style="display: none;">
        <div class="user-info">
          <img id="userAvatar" src="../avatar/default.png" alt="User" class="user-icon">
          <span id="userName" class="user-name">Loading...</span>
        </div>
        <div class="user-points">
          <span id="userPoints">0đ</span>
        </div>
      </div>
      
      <!-- User not logged in state -->
      <div id="usernotLoggedIn" class="user-not-logged-in" style="display: none;">
        <div class="login-prompt">
          <span class="login-text">Đăng nhập để xem thông tin cá nhân</span>
        </div>
        <button class="login-btn" onclick="goToLogin()">
          🔑 Đăng nhập
        </button>
      </div>
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-header-content">
        <div class="profile-avatar">
          <img src="../avatar/default.png" alt="User Avatar" id="profileAvatar">
          <button class="change-avatar-btn" onclick="changeAvatar()">📷</button>
        </div>
        <div class="profile-info">
          <div class="profile-info-top">
            <div class="username-container">
              <h2 id="profileName">Nguyen Van A</h2>
            </div>
            <button class="edit-profile-btn" onclick="toggleEditMode()" title="Chỉnh sửa">✏️</button>
          </div>
          <div class="profile-points"><span id="profilePoints">0 điểm</span></div>
          <p id="profileBio">Người đam mê khám phá văn hóa Việt Nam</p>
        </div>
      </div>
    </div>

    <!-- Stats Section -->
    <div class="stats-section">
      <div class="stat-card">
        <div class="stat-number">189</div>
        <div class="stat-label">Điểm</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">8</div>
        <div class="stat-label">Check-ins</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">5</div>
        <div class="stat-label">Bảo tàng</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">#7</div>
        <div class="stat-label">Xếp hạng</div>
      </div>
    </div>

    <!-- Achievement Section -->
    <div class="achievement-section">
      <h3>🏅 Thành tích</h3>
      <div class="achievement-grid">
        <div class="achievement-card earned">
          <div class="achievement-icon">🏛️</div>
          <div class="achievement-name">Khám phá đầu tiên</div>
          <div class="achievement-desc">Check-in lần đầu</div>
        </div>
        <div class="achievement-card earned">
          <div class="achievement-icon">📍</div>
          <div class="achievement-name">Thám hiểm</div>
          <div class="achievement-desc">5 check-ins</div>
        </div>
        <div class="achievement-card">
          <div class="achievement-icon">🎯</div>
          <div class="achievement-name">Chuyên gia</div>
          <div class="achievement-desc">10 check-ins</div>
        </div>
        <div class="achievement-card">
          <div class="achievement-icon">👑</div>
          <div class="achievement-name">Bậc thầy</div>
          <div class="achievement-desc">Top 3 tuần</div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="activity-section">
      <h3>📋 Hoạt động gần đây</h3>
      <div class="activity-list">
        <div class="activity-item">
          <div class="activity-icon">📍</div>
          <div class="activity-info">
            <p><strong>Check-in tại Bảo tàng Hồ Chí Minh</strong></p>
            <p class="activity-time">Hôm nay, 14:30</p>
          </div>
          <div class="activity-points">+25</div>
        </div>
        <div class="activity-item">
          <div class="activity-icon">🏆</div>
          <div class="activity-info">
            <p><strong>Lên hạng 7</strong></p>
            <p class="activity-time">Hôm nay, 14:31</p>
          </div>
        </div>
        <div class="activity-item">
          <div class="activity-icon">📍</div>
          <div class="activity-info">
            <p><strong>Check-in tại Bảo tàng Lịch sử Quân sự</strong></p>
            <p class="activity-time">Hôm qua, 10:15</p>
          </div>
          <div class="activity-points">+30</div>
        </div>
        <div class="activity-item">
          <div class="activity-icon">🏅</div>
          <div class="activity-info">
            <p><strong>Nhận thành tích "Thám hiểm"</strong></p>
            <p class="activity-time">Hôm qua, 10:16</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Section -->
    <div class="settings-section">
      <h3>⚙️ Cài đặt</h3>
      <div class="settings-list">
        <div class="setting-item" onclick="toggleNotifications()">
          <div class="setting-info">
            <div class="setting-name">Thông báo</div>
            <div class="setting-desc">Nhận thông báo về hoạt động mới</div>
          </div>
          <div class="setting-toggle">
            <input type="checkbox" id="notifications" checked>
            <label for="notifications" class="toggle-switch"></label>
          </div>
        </div>
        <div class="setting-item" onclick="toggleLocation()">
          <div class="setting-info">
            <div class="setting-name">Vị trí</div>
            <div class="setting-desc">Cho phép truy cập vị trí</div>
          </div>
          <div class="setting-toggle">
            <input type="checkbox" id="location" checked>
            <label for="location" class="toggle-switch"></label>
          </div>
        </div>
        <div class="setting-item" onclick="showPrivacySettings()">
          <div class="setting-info">
            <div class="setting-name">Quyền riêng tư</div>
            <div class="setting-desc">Quản lý quyền riêng tư</div>
          </div>
          <div class="setting-arrow">▶</div>
        </div>
        <div class="setting-item logout-item" onclick="logout()">
          <div class="setting-info">
            <div class="setting-name">Đăng xuất</div>
            <div class="setting-desc">Thoát khỏi tài khoản</div>
          </div>
          <div class="setting-arrow">🚪</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item" onclick="navigateToPage('home')">
      <div class="nav-icon">🏠</div>
      <div class="nav-label">Home</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('map')">
      <div class="nav-icon">🗺️</div>
      <div class="nav-label">Map</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('checkin')">
      <div class="nav-icon">📍</div>
      <div class="nav-label">Check-in</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('leaderboard')">
      <div class="nav-icon">🏆</div>
      <div class="nav-label">Bảng xếp hạng</div>
    </div>
    <div class="nav-item active" onclick="navigateToPage('profile')">
      <div class="nav-icon">👤</div>
      <div class="nav-label">Profile</div>
    </div>
  </div>

  <script>
    // Load user info on page load
    async function loadUserInfo() {
      try {
        const response = await fetch('getUserInfo.php');
        if (response.ok) {
          const data = await response.json();
          
          if (data.loggedIn) {
            showUserLoggedInState(data);
          } else {
            showUserNotLoggedInState();
          }
        } else {
          showUserNotLoggedInState();
        }
      } catch (error) {
        console.error('Error loading user info:', error);
        showUserNotLoggedInState();
      }
    }


    
    function showUserLoggedInState(userData) {
      const loggedInDiv = document.getElementById('userLoggedIn');
      const notLoggedInDiv = document.getElementById('usernotLoggedIn');
      
      // Show logged in state, hide not logged in state
      loggedInDiv.style.display = 'flex';
      notLoggedInDiv.style.display = 'none';
      
      // Update user avatar
      const avatarElement = document.getElementById('userAvatar');
      avatarElement.src = userData.avatarRelative || '../avatar/default.png';
      
      // Update user name
      const nameElement = document.getElementById('userName');
      nameElement.textContent = userData.username || 'Guest User';
      
      // Update user points
      const pointsElement = document.getElementById('userPoints');
      pointsElement.textContent = (userData.score || 0) + 'đ';
      
      // Update profile points
      const profilePointsElement = document.getElementById('profilePoints');
      if (profilePointsElement) {
        profilePointsElement.textContent = (userData.score || 0) + ' điểm';
      }
      
      // Thêm verified badge dựa trên role
      const userRole = userData.role ? userData.role.toLowerCase() : 'customer';
      console.log('User role:', userRole);
      
      // Update profile information
      const profileName = document.getElementById('profileName');
      if (profileName) {
        profileName.textContent = userData.username || 'Guest User';
        // Remove any existing role classes from profile name
        profileName.classList.remove('admin', 'customerpre', 'customer');
      }
      
      const profileAvatar = document.getElementById('profileAvatar');
      if (profileAvatar) profileAvatar.src = userData.avatarRelative || '../avatar/default.png';
      
      // Apply role-based styling
      // First, remove any existing role classes
      nameElement.classList.remove('admin', 'customerpre', 'customer');
      avatarElement.classList.remove('admin', 'customerpre', 'customer');
      
      if (profileAvatar) {
        const profileAvatarContainer = document.querySelector('.profile-avatar');
        if (profileAvatarContainer) {
          profileAvatarContainer.classList.remove('admin', 'customerpre', 'customer');
        }
      }
      
      // Then apply the appropriate class based on user's role
      // Add appropriate class based on role
      nameElement.classList.add(userRole);
      avatarElement.classList.add(userRole);
      
      // Thêm class role vào profileName để có cùng style với userName
      if (profileName) profileName.classList.add(userRole);
      
      if (profileAvatar) {
        const profileAvatarContainer = document.querySelector('.profile-avatar');
        if (profileAvatarContainer) {
          profileAvatarContainer.classList.add(userRole);
        }
      }
      
      console.log('Applied styling for role:', userRole);
    }

    function showUserNotLoggedInState() {
      const loggedInDiv = document.getElementById('userLoggedIn');
      const notLoggedInDiv = document.getElementById('usernotLoggedIn');
      
      // Show not logged in state, hide logged in state
      loggedInDiv.style.display = 'none';
      notLoggedInDiv.style.display = 'flex';
    }

    function goToLogin() {
  // Kiểm tra xem có token không (có thể từ localStorage, sessionStorage, hoặc URL parameter)
  const urlParams = new URLSearchParams(window.location.search);
  const tokenFromUrl = urlParams.get('token');
  const tokenFromStorage = localStorage.getItem('nfc_token') || sessionStorage.getItem('nfc_token');
  
  if (tokenFromUrl || tokenFromStorage) {
    // Có token, chuyển đến trang login
    const token = tokenFromUrl || tokenFromStorage;
    window.location.href = `../login.php?token=${token}`;
  } else {
    // Không có token, chuyển đến trang thông báo NFC
    window.location.href = '../nfc_required.html';
  }
}

    // Navigation functions
    function navigateToPage(page) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      event.target.closest('.nav-item').classList.add('active');
      
      switch(page) {
        case 'home':
          window.location.href = '../index.php';
          break;
        case 'map':
          window.location.href = '../map.html';
          break;
        case 'checkin':
          window.location.href = '../checkin/checkin.html';
          break;
        case 'leaderboard':
          window.location.href = '../leaderboard.html';
          break;
        case 'profile':
          // Already on profile page
          break;
      }
    }

    // Profile functions
    function toggleEditMode() {
      const isEditing = document.querySelector('.edit-mode');
      if (isEditing) {
        exitEditMode();
      } else {
        enterEditMode();
      }
    }

    async function enterEditMode() {
      document.body.classList.add('edit-mode');
      const name = document.getElementById('profileName');
      const bio = document.getElementById('profileBio');
      const editBtn = document.querySelector('.edit-profile-btn');
      
      // Lấy và lưu trữ role để dùng sau khi thoát chế độ chỉnh sửa
      const userRole = name.classList.contains('admin') ? 'admin' : 
                      name.classList.contains('customerpre') ? 'customerpre' : 'customer';
      
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = name.innerText;
      nameInput.id = 'nameInput';
      nameInput.className = 'profile-input';
      
      const bioInput = document.createElement('textarea');
      bioInput.value = bio.innerText;
      bioInput.id = 'bioInput';
      bioInput.className = 'profile-input';
      
      // Tạo container cho lịch sử username
      const usernameHistoryContainer = document.createElement('div');
      usernameHistoryContainer.id = 'usernameHistoryContainer';
      usernameHistoryContainer.className = 'username-history-container';
      usernameHistoryContainer.innerHTML = '<p>Đang tải lịch sử username...</p>';
      
      // Thay thế các phần tử
      name.replaceWith(nameInput);
      bio.replaceWith(bioInput);
      
      // Chèn container lịch sử username sau nameInput
      nameInput.parentNode.insertBefore(usernameHistoryContainer, nameInput.nextSibling);
      
      // Cập nhật nút lưu
      editBtn.innerHTML = '💾';
      
      // Lấy lịch sử username từ server
      try {
        const response = await fetch('getUsernameHistory.php');
        const data = await response.json();
        
        if (data.success) {
          let historyContent = '';
          
          // Kiểm tra có thể đổi username hay không
          if (!data.canChangeUsername) {
            historyContent = `<div class="username-change-restriction">
              <p>⏰ Bạn có thể đổi username sau ${data.daysRemaining} ngày nữa</p>
            </div>`;
            
            // Disable nameInput nếu chưa đủ 90 ngày
            nameInput.disabled = true;
            nameInput.title = `Bạn chỉ có thể đổi username sau ${data.daysRemaining} ngày nữa`;
          }
          
          // Thêm lịch sử username nếu có
          if (data.history.length > 0) {
            historyContent += '<div class="username-history-list"><h4>Lịch sử username cũ:</h4><ul>';
            
            data.history.forEach(item => {
              // Định dạng ngày tháng
              const date = new Date(item.changeDate);
              const formattedDate = date.toLocaleDateString('vi-VN') + ' ' + 
                                   date.toLocaleTimeString('vi-VN');
              
              historyContent += `<li>${formattedDate} - ${item.username}</li>`;
            });
            
            historyContent += '</ul></div>';
          }
          
          // Cập nhật nội dung container
          if (historyContent) {
            usernameHistoryContainer.innerHTML = historyContent;
          } else {
            usernameHistoryContainer.style.display = 'none';
          }
        } else {
          usernameHistoryContainer.innerHTML = '<p>Không thể tải lịch sử username</p>';
        }
      } catch (error) {
        console.error('Lỗi khi tải lịch sử username:', error);
        usernameHistoryContainer.innerHTML = '<p>Đã xảy ra lỗi khi tải lịch sử</p>';
      }
    }

    async function exitEditMode() {
      const nameInput = document.getElementById('nameInput');
      const bioInput = document.getElementById('bioInput');
      const editBtn = document.querySelector('.edit-profile-btn');
      
      // Xóa container lịch sử username
      const usernameHistoryContainer = document.getElementById('usernameHistoryContainer');
      if (usernameHistoryContainer) {
        usernameHistoryContainer.remove();
      }
      
      // Lưu giá trị hiện tại để khôi phục nếu cần
      const currentNameValue = nameInput.value.trim();
      const currentBioValue = bioInput.value.trim();
      
      // Lấy tên hiện tại từ phần tử userName
      const currentUsername = document.getElementById('userName').textContent;
      
      // Lấy role hiện tại để tạo lại badge
      const userRole = document.getElementById('userName').classList.contains('admin') ? 'admin' : 
                      document.getElementById('userName').classList.contains('customerpre') ? 'customerpre' : 'customer';
      
      // Kiểm tra nếu username thay đổi
      if (currentNameValue !== currentUsername) {
        try {
          // Gửi yêu cầu cập nhật username
          const response = await fetch('updateUsername.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username: currentNameValue })
          });
          
          const data = await response.json();
          
          if (!data.success) {
            // Hiển thị thông báo lỗi
            alert(data.message);
            
            // Khôi phục tên cũ
            nameInput.value = currentUsername;
            return; // Không thoát khỏi chế độ chỉnh sửa
          } else {
            // Cập nhật thành công, hiển thị thông báo
            alert('Tên người dùng đã được cập nhật thành công!');
            
            // Cập nhật tên trong toàn bộ giao diện
            document.getElementById('userName').textContent = currentNameValue;
          }
        } catch (error) {
          console.error('Lỗi khi cập nhật tên người dùng:', error);
          alert('Đã xảy ra lỗi khi cập nhật tên người dùng');
          return; // Không thoát khỏi chế độ chỉnh sửa
        }
      }
      
      // Thoát khỏi chế độ chỉnh sửa
      document.body.classList.remove('edit-mode');
      
      const name = document.createElement('h2');
      name.id = 'profileName';
      name.innerText = currentNameValue;
      name.classList.add(userRole); // Thêm lại class role
      
      const bio = document.createElement('p');
      bio.id = 'profileBio';
      bio.innerText = currentBioValue;
      
      nameInput.replaceWith(name);
      bioInput.replaceWith(bio);
      editBtn.innerHTML = '✏️';
      

      
      // TODO: Lưu bio vào server (chức năng này sẽ được phát triển sau)
      console.log('Profile saved:', { name: currentNameValue, bio: currentBioValue });
    }

    function changeAvatar() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/jpeg,image/png,image/gif';
      input.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Kiểm tra kích thước file (giới hạn 2MB)
        if (file.size > 2 * 1024 * 1024) {
          alert('Kích thước file quá lớn. Giới hạn 2MB');
          return;
        }
        
        // Hiển thị trước ảnh
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profileAvatar').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // Tạo FormData để gửi lên server
        const formData = new FormData();
        formData.append('avatar', file);
        
        try {
          // Hiển thị trạng thái đang tải lên
          const profileAvatar = document.getElementById('profileAvatar');
          const originalSrc = profileAvatar.src;
          const originalStyle = profileAvatar.style.opacity;
          profileAvatar.style.opacity = '0.5';
          
          // Gửi dữ liệu lên server
          const response = await fetch('uploadAvatar.php', {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          
          // Khôi phục trạng thái avatar
          profileAvatar.style.opacity = originalStyle;
          
          if (data.success) {
            // Cập nhật avatar mới
            document.getElementById('profileAvatar').src = data.avatarUrl;
            document.getElementById('userAvatar').src = data.avatarUrl;
            
            // Thông báo thành công
            alert('Ảnh đại diện đã được cập nhật thành công');
          } else {
            // Hiển thị lỗi và khôi phục avatar cũ
            alert('Lỗi khi cập nhật ảnh đại diện: ' + data.message);
            document.getElementById('profileAvatar').src = originalSrc;
          }
        } catch (error) {
          console.error('Lỗi khi tải lên avatar:', error);
          alert('Đã xảy ra lỗi khi tải lên ảnh đại diện');
          // Khôi phục trạng thái avatar
          document.getElementById('profileAvatar').style.opacity = originalStyle;
        }
      };
      input.click();
    }

    function toggleNotifications() {
      const checkbox = document.getElementById('notifications');
      checkbox.checked = !checkbox.checked;
      console.log('Notifications:', checkbox.checked);
    }

    function toggleLocation() {
      const checkbox = document.getElementById('location');
      checkbox.checked = !checkbox.checked;
      console.log('Location:', checkbox.checked);
    }

    function showPrivacySettings() {
      alert('Cài đặt quyền riêng tư sẽ được phát triển trong phiên bản tiếp theo');
    }

    function logout() {
      if (confirm('Bạn có chắc muốn đăng xuất?')) {
        // Clear all client-side storage
        sessionStorage.clear();
        localStorage.clear();
        
        // Clear any cookies (optional, for completeness)
        document.cookie.split(";").forEach(function(c) { 
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
        });
        
        // Redirect to logout.php to clear server-side session
        window.location.href = '../logout.php';
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadUserInfo();
      console.log('Profile page loaded');
    });
  </script>
</body>
</html>