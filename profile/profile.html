<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile - Vietnamese Memories</title>
  <link rel="icon" type="image/png" href="../logo.PNG" />
  <link rel="stylesheet" href="../style.css" />
  <!-- Google Fonts cho Role & Rank Badges -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&family=Momo+Signature&display=swap" rel="stylesheet">
  <!-- Th√™m th∆∞ vi·ªán Cropper.js (trong th·ª±c t·∫ø b·∫°n n√™n t·∫£i th∆∞ vi·ªán n√†y) -->
  <script>
    // ƒê√¢y ch·ªâ l√† ph·∫ßn gi·∫£ l·∫≠p v√¨ ch√∫ng ta kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán trong demo n√†y
    // Trong d·ª± √°n th·ª±c t·∫ø, b·∫°n n√™n t·∫£i Cropper.js t·ª´ CDN ho·∫∑c c√†i ƒë·∫∑t qua npm
    console.log("Cropper.js would be loaded here in a real implementation");
  </script>
  <style>
    /* Container position relative ƒë·ªÉ l√†m ƒëi·ªÉm tham chi·∫øu cho overlay */
    .container {
      position: relative;
    }
    
    /* Login required page styling - thay th·∫ø overlay c≈© */
    .login-required-page {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      text-align: center;
      padding: 20px;
    }
    
    .login-required-content {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px 30px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
      max-width: 350px;
      width: 100%;
    }
    
    .login-required-icon {
      font-size: 80px;
      margin-bottom: 20px;
      opacity: 0.8;
    }
    
    .login-required-title {
      font-size: 28px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }
    
    .login-required-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
    }
    
    .login-required-button {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 15px 40px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 15px rgba(79, 172, 254, 0.3);
    }
    
    .login-required-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 25px rgba(79, 172, 254, 0.4);
    }
    
    .login-required-button:active {
      transform: translateY(-1px);
    }
    
    /* Profile header - ·∫©n khi ch∆∞a ƒëƒÉng nh·∫≠p */
    .profile-header {
      background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.5)), 
                  url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=400&fit=crop') center/cover;
      padding: 30px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
      min-height: 240px;
      text-align: center;
      display: none; /* ·∫®n m·∫∑c ƒë·ªãnh, hi·ªán khi ƒëƒÉng nh·∫≠p */
      background-size: cover;
      background-position: center;
    }
    

    .profile-header-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .profile-avatar {
      position: relative;
      margin-bottom: 15px;
    }

    .profile-avatar img {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.25);
      transition: transform 0.3s ease;
    }
    
    .profile-avatar img:hover {
      transform: scale(1.05);
    }

    .profile-info {
      z-index: 2;
      position: relative;
      width: 100%;
      text-align: center;
    }

    .profile-info-top {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      margin-bottom: 10px;
    }

    .username-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 5px;
    }

    .profile-info h2 {
      margin: 5px 0;
      color: white;
      font-size: 32px;
      display: inline-block;
      padding: 3px 0;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8), 0 0 20px rgba(0, 0, 0, 0.6);
      font-weight: bold;
    }

    .profile-points {
      display: none; /* ·∫®n ƒë·ªÉ tr√°nh l·∫∑p v·ªõi stats section */
      color: #fcff32;
      font-size: 22px;
      font-weight: bold;
      margin: 10px 0;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
    }

    /* ·∫®n bio */
    .profile-info p {
      display: none;
    }

    .edit-profile-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 35px;
      height: 35px;
      min-width: 35px; /* ƒê·∫£m b·∫£o kh√¥ng b·ªã co l·∫°i */
      cursor: pointer;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
      margin-left: 10px;
    }

    .edit-profile-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    /* Style cho n√∫t l∆∞u khi ƒëang ch·ªânh s·ª≠a */
    .edit-mode .edit-profile-btn {
      background: rgba(46, 204, 113, 0.7);
      border-color: rgba(46, 204, 113, 0.8);
    }
    
    .edit-mode .edit-profile-btn:hover {
      background: rgba(46, 204, 113, 0.9);
    }

    /* ·∫®n header ·ªü tr√™n */
    .user-header {
      display: none !important;
    }
    
    /* Style cho ch·∫ø ƒë·ªô ch·ªânh s·ª≠a */
    .profile-input {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 6px;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    
    #bioInput {
      min-height: 80px;
      resize: vertical;
    }
    
    .username-history-container {
      margin: 10px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: white;
      font-size: 14px;
    }


    
    /* Overlay cho ng∆∞·ªùi d√πng ch∆∞a ƒëƒÉng nh·∫≠p */
    .not-logged-in-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 60px; /* ƒê·ªÉ tr√°nh che thanh navigator */
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 100;
      text-align: center;
      padding: 20px;
      border-radius: 12px;
    }
    
    /* Modal popup ch·ªânh s·ª≠a th√¥ng tin c√° nh√¢n */
    .edit-profile-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90%;
      max-width: 350px;
      background-color: rgba(255, 255, 255, 1);
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      padding: 20px 0; /* Thay ƒë·ªïi padding ƒë·ªÉ gi·ªØ l·ªÅ tr√™n/d∆∞·ªõi v√† b·ªè l·ªÅ tr√°i/ph·∫£i */
      display: none;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
      box-sizing: border-box;
    }
    
    .modal-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 0 20px; /* Th√™m padding cho header ƒë·ªÉ ƒë·∫£m b·∫£o c√≥ kh√¥ng gian ·ªü hai b√™n */
      box-sizing: border-box;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    
    .modal-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #eee;
      margin-bottom: 15px;
    }
    
    .modal-username {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 25px;
    }
    
    .modal-options {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 0 15px; /* Th√™m padding cho container ƒë·ªÉ t·∫°o kho·∫£ng c√°ch 2 b√™n */
      box-sizing: border-box;
    }
    
    .modal-option {
      width: 100%;
      background-color: white;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 12px 15px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 2px;
      box-sizing: border-box;
    }
    
    .modal-option:hover {
      background-color: #f8f9fa;
    }
    
    .modal-option-icon {
      margin-right: 15px;
      font-size: 20px;
      color: #555;
    }
    
    .modal-option-text {
      font-size: 16px;
      color: #333;
    }
    
    /* Username input modal */
    .username-edit-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%; /* TƒÉng ƒë·ªô r·ªông m·ªôt ch√∫t ƒë·ªÉ khung nh√¨n d·ªÖ ch·ªãu h∆°n */
      max-width: 350px;
      background-color: #1a1e25;
      color: white;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      z-index: 1001;
      padding: 0;
      display: none;
      flex-direction: column;
      overflow: hidden;
      box-sizing: border-box;
    }
    
    .username-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .username-modal-title {
      font-size: 18px;
      font-weight: bold;
      color: white;
    }
    
    .username-modal-close, .username-modal-back {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .username-modal-content {
      padding: 20px 5px; /* Gi·∫£m padding ngang ƒë·ªÉ cho ph√©p margin c·ªßa input ho·∫°t ƒë·ªông ƒë√∫ng */
    }
    
    .username-input-label {
      display: block;
      margin: 0 15px 10px 15px; /* ƒê·ªìng b·ªô v·ªõi margin c·ªßa input */
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
    }
    
    .username-input {
      width: calc(100% - 30px); /* Gi·∫£m chi·ªÅu r·ªông ƒë·ªÉ t·∫°o l·ªÅ 2 b√™n */
      background-color: #2a3140;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 15px;
      font-size: 16px;
      margin: 0 15px 20px 15px; /* T·∫°o kho·∫£ng c√°ch 15px ·ªü hai b√™n */
      box-sizing: border-box;
    }
    
    .username-input:focus {
      outline: none;
      box-shadow: 0 0 0 2px rgba(75, 171, 247, 0.5);
    }
    
    .username-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 10px 15px 20px; /* ƒê·ªìng b·ªô padding v·ªõi margin c·ªßa input */
    }
    
    .username-modal-button {
      background-color: #5bc0de;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 20px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .username-modal-button.cancel {
      background-color: transparent;
      color: #5bc0de;
    }
    
    /* Error message styling */
    .username-error-message {
      color: #ff3333;
      font-size: 14px;
      margin: 8px 15px;
      display: none;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Avatar crop modal */
    .avatar-crop-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #222;
      color: white;
      z-index: 1002;
      display: none;
      flex-direction: column;
    }
    
    .crop-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background-color: #1a1e25;
    }
    
    .crop-title {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      flex-grow: 1;
    }
    
    .crop-back {
      background: none;
      border: none;
      color: white;
      font-size: 22px;
      cursor: pointer;
      width: 40px;
      padding: 0;
      text-align: left;
    }
    
    .crop-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 20px;
      overflow: hidden;
    }
    
    .crop-preview {
      max-width: 100%;
      max-height: 60vh;
      margin-bottom: 20px;
      border-radius: 50%;
      overflow: hidden;
    }
    
    .crop-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .crop-actions {
      width: 100%;
      display: flex;
      justify-content: center;
      padding: 20px;
      background-color: #1a1e25;
    }
    
    .crop-button {
      background-color: #6c5ce7;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 10px 30px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .crop-button:hover {
      background-color: #5b4cc7;
    }
    
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 999;
      display: none;
    }
    
    .not-logged-in-message {
      color: white;
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 25px;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    }
    
    .login-button {
      background-color: #44bd32;
      color: white;
      font-size: 18px;
      font-weight: bold;
      padding: 15px 30px;
      border: none;
      border-radius: 30px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .login-button:hover {
      background-color: #4cd137;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }
    
    .login-button-icon {
      margin-right: 10px;
      font-size: 20px;
    }

    /* Username container styling */
    .username-container {
      display: flex;
      align-items: center;
      position: relative;
    }
    
    /* Role badge styling */
    .role-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 15px;
      border-radius: 20px;
      font-family: 'Momo Signature', cursive;
      font-size: 16px;
      font-weight: normal;
      margin: 8px 0;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
      position: relative;
      text-transform: none;
      letter-spacing: 1px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    /* Premium user badge */
    .role-badge.premium {
      background: linear-gradient(135deg, #4cd137, #44bd32);
      color: #fff;
      padding-left: 35px;
    }
    
    .role-badge.premium::before {
      content: "üëë";
      position: absolute;
      left: 12px;
      font-size: 16px;
    }
    
    /* Admin badge */
    .role-badge.admin {
      background: linear-gradient(135deg, #f44336, #b71c1c);
      color: #fff;
    }
    
    /* VIP badge */
    .role-badge.vip {
      background: linear-gradient(135deg, #ffd700, #ffed4e);
      color: #1a1a1a;
      font-size: 18px;
      box-shadow: 0 4px 8px rgba(255, 215, 0, 0.4);
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.3);
    }
    
    /* Standard badge */
    .role-badge.standard {
      background: linear-gradient(135deg, #64b5f6, #42a5f5);
      color: #fff;
    }
    
    /* Role-specific avatar styling */
    .profile-avatar.premium img {
      border-color: #44bd32;
      box-shadow: 0 6px 12px rgba(68, 189, 50, 0.3);
    }
    
    .profile-avatar.vip img {
      border-color: #ffd700;
      box-shadow: 0 6px 12px rgba(255, 215, 0, 0.5);
    }
    
    .profile-avatar.standard img {
      border-color: #42a5f5;
      box-shadow: 0 6px 12px rgba(66, 165, 245, 0.3);
    }
    
    .profile-avatar.admin img {
      border-color: #f44336;
      box-shadow: 0 6px 12px rgba(244, 67, 54, 0.3);
    }
    
    /* Premium user crown - ƒë√£ x√≥a bi·ªÉu t∆∞·ª£ng ng√¥i sao */
    .profile-avatar.premium::before {
      content: none;
    }
    
    /* Rank badge styling */
    .rank-badge {
      display: inline-flex;
      align-items: center;
      padding: 5px 14px;
      border-radius: 15px;
      font-family: 'Momo Signature', cursive;
      font-size: 14px;
      font-weight: normal;
      margin: 5px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      position: relative;
      text-transform: none;
      letter-spacing: 0.5px;
      background: linear-gradient(135deg, var(--rank-color, #666), var(--rank-color-dark, #555));
      color: white;
    }
    
    /* Progress bar for rank progression */
    .rank-progress {
      margin-top: 10px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      height: 6px;
      overflow: hidden;
      width: 100%;
    }
    
    .rank-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--rank-color, #4CAF50), var(--next-rank-color, #66BB6A));
      transition: width 0.3s ease;
      border-radius: 10px;
    }
    
    /* Activity item points styling */
    .activity-points {
      color: #4CAF50;
      font-weight: bold;
      font-size: 14px;
      margin-left: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Login Required Page - hi·ªÉn th·ªã khi ch∆∞a ƒëƒÉng nh·∫≠p -->
    <div class="login-required-page" id="loginRequiredPage">
      <div class="login-required-content">
        <div class="login-required-icon">üîê</div>
        <h1 class="login-required-title">ƒêƒÉng nh·∫≠p c·∫ßn thi·∫øt</h1>
        <p class="login-required-message">
          Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem th√¥ng tin c√° nh√¢n v√† tr·∫£i nghi·ªám ƒë·∫ßy ƒë·ªß t√≠nh nƒÉng c·ªßa K√Ω ·ª®c Vi·ªát
        </p>
        <button class="login-required-button" onclick="goToLogin()">
          üîë ƒêƒÉng nh·∫≠p ngay
        </button>
      </div>
    </div>

    <!-- User Header -->
    <div class="user-header" id="userHeader">
      <!-- User logged in state -->
      <div id="userLoggedIn" class="user-logged-in" style="display: none;">
        <div class="user-info">
          <img id="userAvatar" src="../avatar/default.png" alt="User" class="user-icon">
          <span id="userName" class="user-name">Loading...</span>
        </div>
        <div class="user-points">
          <span id="userPoints">0ƒë</span>
        </div>
      </div>
      
      <!-- User not logged in state -->
      <div id="usernotLoggedIn" class="user-not-logged-in" style="display: none;">
        <div class="login-prompt">
          <span class="login-text">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem th√¥ng tin c√° nh√¢n</span>
        </div>
        <button class="login-btn" onclick="goToLogin()">
          üîë ƒêƒÉng nh·∫≠p
        </button>
      </div>
    </div>

    <!-- Profile Header - Hi·ªÉn th·ªã khi ƒë√£ ƒëƒÉng nh·∫≠p -->
    <div class="profile-header" id="profileHeader">
      <div class="profile-header-content">
        <div class="profile-avatar">
          <img src="../avatar/default.png" alt="User Avatar" id="profileAvatar">
        </div>
        <div class="profile-info">
          <div class="profile-info-top">
            <div class="username-container">
              <h2 id="profileName">Loading...</h2>
              <!-- Role badge s·∫Ω ƒë∆∞·ª£c th√™m v√†o b·ªüi JavaScript -->
            </div>
          </div>
          <div class="profile-points"><span id="profilePoints">0 ƒëi·ªÉm</span></div>
          <!-- Bio ƒë√£ ƒë∆∞·ª£c ·∫©n theo y√™u c·∫ßu -->
        </div>
      </div>
    </div>

    <!-- Stats Section - Will be populated dynamically -->
    <div class="stats-section" id="statsSection" style="display: none;">
      <!-- Stats will be loaded via JavaScript -->
    </div>

    <!-- Achievement Section - Will be populated dynamically -->
    <div class="achievement-section" id="achievementSection" style="display: none;">
      <h3>üèÖ Th√†nh t√≠ch</h3>
      <div class="achievement-grid" id="achievementGrid">
        <!-- Achievements will be loaded via JavaScript -->
      </div>
    </div>

    <!-- Recent Activity - Will be populated dynamically -->
    <div class="activity-section" id="activitySection" style="display: none;">
      <h3>üìã Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>
      <div class="activity-list" id="activityList">
        <!-- Activities will be loaded via JavaScript -->
      </div>
    </div>

    <!-- Settings Section - Will be populated dynamically -->
    <div class="settings-section" id="settingsSection" style="display: none;">
      <h3>‚öôÔ∏è C√†i ƒë·∫∑t</h3>
      <div class="settings-list">
        <div class="setting-item" onclick="showEditProfileModal()">
          <div class="setting-info">
            <div class="setting-name">Ch·ªânh s·ª≠a th√¥ng tin c√° nh√¢n</div>
            <div class="setting-desc">Thay ƒë·ªïi avatar v√† t√™n hi·ªÉn th·ªã</div>
          </div>
          <div class="setting-arrow">‚ñ∂</div>
        </div>
        <div class="setting-item" onclick="toggleLocation()">
          <div class="setting-info">
            <div class="setting-name">V·ªã tr√≠</div>
            <div class="setting-desc">Cho ph√©p truy c·∫≠p v·ªã tr√≠</div>
          </div>
          <div class="setting-toggle">
            <input type="checkbox" id="location" checked>
            <label for="location" class="toggle-switch"></label>
          </div>
          <div class="setting-arrow">‚ñ∂</div>
        </div>
        <div class="setting-item" onclick="showAboutUs()">
          <div class="setting-info">
            <div class="setting-name">Gi·ªõi thi·ªáu</div>
            <div class="setting-desc">Th√¥ng tin v·ªÅ ·ª©ng d·ª•ng</div>
          </div>
          <div class="setting-arrow">‚ñ∂</div>
        </div>
        <div class="setting-item logout-item" onclick="logout()">
          <div class="setting-info">
            <div class="setting-name">ƒêƒÉng xu·∫•t</div>
            <div class="setting-desc">Tho√°t kh·ªèi t√†i kho·∫£n</div>
          </div>
          <div class="setting-arrow">‚ñ∂</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal Ch·ªânh s·ª≠a th√¥ng tin c√° nh√¢n -->
  <div class="modal-backdrop" id="modalBackdrop"></div>
  <div class="edit-profile-modal" id="editProfileModal">
    <div class="modal-header">
      <div class="modal-title">Ch·ªânh s·ª≠a th√¥ng tin</div>
      <button class="modal-close" onclick="closeEditProfileModal()">√ó</button>
    </div>
    <img src="../avatar/default.png" alt="Avatar" class="modal-avatar" id="modalAvatar">
    <div class="modal-username" id="modalUsername">Ng∆∞·ªùi d√πng</div>
    <div class="modal-options">
      <div class="modal-option" onclick="editAvatar()">
        <span class="modal-option-icon">üñºÔ∏è</span>
        <span class="modal-option-text">Thay ƒë·ªïi ·∫£nh ƒë·∫°i di·ªán</span>
      </div>
      <div class="modal-option" onclick="editUsername()">
        <span class="modal-option-icon">‚úèÔ∏è</span>
        <span class="modal-option-text">Thay ƒë·ªïi t√™n hi·ªÉn th·ªã</span>
      </div>
    </div>
  </div>
  
  <!-- Modal ch·ªânh s·ª≠a t√™n ng∆∞·ªùi d√πng -->
  <div class="username-edit-modal" id="usernameEditModal">
    <div class="username-modal-header">
      <button class="username-modal-back" onclick="backToMainEditModal()">‚Üê</button>
      <div class="username-modal-title">Ch·ªânh s·ª≠a t√™n ng∆∞·ªùi d√πng</div>
      <button class="username-modal-close" onclick="closeAllModals()">√ó</button>
    </div>
    <div class="username-modal-content">
      <label for="newUsername" class="username-input-label">T√™n ng∆∞·ªùi d√πng</label>
      <input type="text" id="newUsername" class="username-input" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi d√πng m·ªõi">
      <div class="username-error-message" id="usernameError"></div>
    </div>
    <div class="username-modal-actions">
      <button class="username-modal-button cancel" onclick="backToMainEditModal()">H·ªßy</button>
      <button class="username-modal-button" onclick="saveUsername()">OK</button>
    </div>
  </div>
  
  <!-- Modal crop ·∫£nh ƒë·∫°i di·ªán -->
  <div class="avatar-crop-modal" id="avatarCropModal">
    <div class="crop-header">
      <button class="crop-back" onclick="backFromCropModal()">‚Üê</button>
      <div class="crop-title">Crop & ƒëi·ªÅu ch·ªânh</div>
      <div style="width: 40px;"></div>
    </div>
    <div class="crop-container">
      <div class="crop-preview">
        <img id="cropPreviewImg" src="" alt="Preview">
      </div>
    </div>
    <div class="crop-actions">
      <button class="crop-button" onclick="saveCroppedAvatar()">Next</button>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item" onclick="navigateToPage('home')">
      <div class="nav-icon">üè†</div>
      <div class="nav-label">Home</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('map')">
      <div class="nav-icon">üó∫Ô∏è</div>
      <div class="nav-label">Map</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('checkin')">
      <div class="nav-icon">üìç</div>
      <div class="nav-label">Check-in</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('leaderboard')">
      <div class="nav-icon">üèÜ</div>
      <div class="nav-label">B·∫£ng x·∫øp h·∫°ng</div>
    </div>
    <div class="nav-item active" onclick="navigateToPage('profile')">
      <div class="nav-icon">üë§</div>
      <div class="nav-label">Profile</div>
    </div>
  </div>

  <script>
    // Load user info on page load
    async function loadUserInfo() {
      try {
        const response = await fetch('getUserProfileComplete.php');
        if (response.ok) {
          const data = await response.json();
          console.log('API Response:', data); // Debug: xem data t·ª´ API
          
          if (data.success && data.loggedIn) {
            console.log('User Stats:', data.profile.stats); // Debug: xem stats data
            showUserLoggedInState(data.profile); // Truy·ªÅn data.profile thay v√¨ data
          } else {
            showUserNotLoggedInState();
          }
        } else {
          showUserNotLoggedInState();
        }
      } catch (error) {
        console.error('Error loading user info:', error);
        showUserNotLoggedInState();
      }
    }


    
    function showUserLoggedInState(userData) {
      const loggedInDiv = document.getElementById('userLoggedIn');
      const notLoggedInDiv = document.getElementById('usernotLoggedIn');
      const loginRequiredPage = document.getElementById('loginRequiredPage');
      const profileHeader = document.getElementById('profileHeader');
      
      // ·∫®n trang ƒëƒÉng nh·∫≠p, hi·ªán n·ªôi dung profile
      loginRequiredPage.style.display = 'none';
      profileHeader.style.display = 'block';
      
      // Show logged in state, hide not logged in state
      loggedInDiv.style.display = 'flex';
      notLoggedInDiv.style.display = 'none';
      
      // Hi·ªán t·∫•t c·∫£ sections
      document.getElementById('statsSection').style.display = 'block';
      document.getElementById('achievementSection').style.display = 'block';
      document.getElementById('activitySection').style.display = 'block';
      document.getElementById('settingsSection').style.display = 'block';
      
      // Update user avatar
      const avatarElement = document.getElementById('userAvatar');
      console.log('Avatar debug - userData.avatar:', userData.avatar);
      avatarElement.src = userData.avatar || '../avatar/default.png';
      avatarElement.onerror = function() { 
        this.src = '../avatar/default.png'; 
        console.log('Avatar failed to load, using default'); 
      };
      
      // Update user name
      const nameElement = document.getElementById('userName');
      nameElement.textContent = userData.username || 'Guest User';
      
      // Update user points
      const pointsElement = document.getElementById('userPoints');
      pointsElement.textContent = (userData.score || 0) + 'ƒë';
      
      // Update profile points with rank info
      const profilePointsElement = document.getElementById('profilePoints');
      if (profilePointsElement) {
        profilePointsElement.textContent = (userData.score || 0) + ' ƒëi·ªÉm';
        profilePointsElement.style.textShadow = '0 0 5px rgba(75, 171, 247, 0.5)';
      }
      
      // Update profile information
      const profileName = document.getElementById('profileName');
      if (profileName) {
        profileName.textContent = userData.username || 'Guest User';
        // Remove any existing role classes from profile name
        profileName.classList.remove('admin', 'vip', 'premium', 'standard', 'free');
        
        // Set m√†u theo role thay v√¨ rank
        const userRole = userData.role ? userData.role.toLowerCase() : 'standard';
        if (userRole === 'admin') {
          profileName.style.color = '#f44336'; // ƒê·ªè
        } else if (userRole === 'vip') {
          profileName.style.color = '#ffd700'; // V√†ng
        } else if (userRole === 'premium') {
          profileName.style.color = '#44bd32'; // Xanh l√°
        } else if (userRole === 'standard') {
          profileName.style.color = '#42a5f5'; // Xanh d∆∞∆°ng
        } else {
          profileName.style.color = '#ffffff'; // Tr·∫Øng cho Free
        }
        
        // Th√™m badge theo role v√† rank
        const usernameContainer = document.querySelector('.username-container');
        if (usernameContainer) {
          // Remove any existing badges
          const existingBadges = usernameContainer.querySelectorAll('.role-badge, .rank-badge');
          existingBadges.forEach(badge => badge.remove());
          
          // Add role-specific badge
          const userRole = userData.role ? userData.role.toLowerCase() : 'standard';
          
          // Map role t·ª´ database: Admin, Standard, Premium, VIP
          if (userRole === 'admin') {
            const badge = document.createElement('span');
            badge.className = 'role-badge admin';
            badge.textContent = 'ADMIN';
            usernameContainer.appendChild(badge);
          } else if (userRole === 'premium') {
            const badge = document.createElement('span');
            badge.className = 'role-badge premium';
            badge.textContent = 'PREMIUM';
            usernameContainer.appendChild(badge);
          } else if (userRole === 'vip') {
            const badge = document.createElement('span');
            badge.className = 'role-badge vip';
            badge.textContent = 'VIP';
            usernameContainer.appendChild(badge);
          } else if (userRole === 'standard') {
            const badge = document.createElement('span');
            badge.className = 'role-badge standard';
            badge.textContent = 'STANDARD';
            usernameContainer.appendChild(badge);
          }
          // Free kh√¥ng hi·ªÉn th·ªã badge
          
          // Add rank badge
          if (userData.rank) {
            const rankBadge = document.createElement('span');
            rankBadge.className = 'role-badge';
            rankBadge.style.background = userData.rank.color || '#666';
            rankBadge.style.color = 'white';
            rankBadge.textContent = userData.rank.icon + ' ' + userData.rank.nameVi;
            usernameContainer.appendChild(rankBadge);
          }
        }
      }
      
      const profileAvatar = document.getElementById('profileAvatar');
      if (profileAvatar) {
        console.log('Profile avatar debug - userData.avatar:', userData.avatar);
        profileAvatar.src = userData.avatar || '../avatar/default.png';
        profileAvatar.onerror = function() { 
          this.src = '../avatar/default.png'; 
          console.log('Profile avatar failed to load, using default'); 
        };
      }
      
      // Set custom background if user has one (feature for future)
      const profileHeaderElement = document.getElementById('profileHeader');
      if (profileHeaderElement && userData.customBackground) {
        profileHeaderElement.style.backgroundImage = `linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.5)), url('${userData.customBackground}')`;
      }
      
      // Update stats cards with real data (pass both userData and stats)
      updateStatsCards(userData.stats, userData.score);
      
      // Update achievements section with real data
      updateAchievementsSection(userData.recentAchievements);
      
      // Update activities section with real data
      updateActivitiesSection(userData.recentActivities);
      
      // Apply role-based styling for compatibility
      const userRoleClass = userData.role ? userData.role.toLowerCase() : 'standard';
      nameElement.classList.add(userRoleClass);
      avatarElement.classList.add(userRoleClass);
      if (profileName) profileName.classList.add(userRoleClass);
      
      console.log('Profile loaded successfully with ranking data:', userData);
    }

    function showUserNotLoggedInState() {
      const loggedInDiv = document.getElementById('userLoggedIn');
      const notLoggedInDiv = document.getElementById('usernotLoggedIn');
      const loginRequiredPage = document.getElementById('loginRequiredPage');
      const profileHeader = document.getElementById('profileHeader');
      
      // Show not logged in state, hide logged in state
      loggedInDiv.style.display = 'none';
      notLoggedInDiv.style.display = 'flex';
      
      // Hi·ªán trang ƒëƒÉng nh·∫≠p, ·∫©n profile header
      loginRequiredPage.style.display = 'flex';
      profileHeader.style.display = 'none';
      
      // ·∫®n t·∫•t c·∫£ sections
      document.getElementById('statsSection').style.display = 'none';
      document.getElementById('achievementSection').style.display = 'none';
      document.getElementById('activitySection').style.display = 'none';
      document.getElementById('settingsSection').style.display = 'none';
    }

    function goToLogin() {
  // Ki·ªÉm tra xem c√≥ token kh√¥ng (c√≥ th·ªÉ t·ª´ localStorage, sessionStorage, ho·∫∑c URL parameter)
  const urlParams = new URLSearchParams(window.location.search);
  const tokenFromUrl = urlParams.get('token');
  const tokenFromStorage = localStorage.getItem('nfc_token') || sessionStorage.getItem('nfc_token');
  
  if (tokenFromUrl || tokenFromStorage) {
    // C√≥ token, chuy·ªÉn ƒë·∫øn trang login
    const token = tokenFromUrl || tokenFromStorage;
    window.location.href = `../login.php?token=${token}`;
  } else {
    // Kh√¥ng c√≥ token, chuy·ªÉn ƒë·∫øn trang th√¥ng b√°o NFC
    window.location.href = '../nfc_required.html';
  }
}

    // Navigation functions
    function navigateToPage(page) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      event.target.closest('.nav-item').classList.add('active');
      
      switch(page) {
        case 'home':
          window.location.href = '../index.php';
          break;
        case 'map':
          window.location.href = '../map.html';
          break;
        case 'checkin':
          window.location.href = '../checkin/checkin.html';
          break;
        case 'leaderboard':
          window.location.href = '/leaderboard/leaderboard.html';
          break;
        case 'profile':
          // Already on profile page
          break;
      }
    }

    // Profile functions
    function toggleEditMode() {
      // T·∫°m th·ªùi v√¥ hi·ªáu h√≥a ch·ª©c nƒÉng ch·ªânh s·ª≠a
      console.log("Ch·ª©c nƒÉng ch·ªânh s·ª≠a t·∫°m th·ªùi b·ªã v√¥ hi·ªáu h√≥a ƒë·ªÉ b·∫£o tr√¨");
      // Hi·ªÉn th·ªã th√¥ng b√°o cho ng∆∞·ªùi d√πng n·∫øu c·∫ßn
      alert("Ch·ª©c nƒÉng ch·ªânh s·ª≠a h·ªì s∆° ƒëang ƒë∆∞·ª£c b·∫£o tr√¨. Vui l√≤ng th·ª≠ l·∫°i sau.");
      
      /* ƒê√£ v√¥ hi·ªáu h√≥a
      const isEditing = document.querySelector('.edit-mode');
      if (isEditing) {
        exitEditMode();
      } else {
        enterEditMode();
      }
      */
    }

    async function enterEditMode() {
      document.body.classList.add('edit-mode');
      const name = document.getElementById('profileName');
      const bio = document.getElementById('profileBio');
      const editBtn = document.querySelector('.edit-profile-btn');
      
      // L·∫•y v√† l∆∞u tr·ªØ role ƒë·ªÉ d√πng sau khi tho√°t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
      const userRole = name.classList.contains('admin') ? 'admin' : 
                      name.classList.contains('customerpre') ? 'customerpre' : 'customer';
      
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = name.innerText;
      nameInput.id = 'nameInput';
      nameInput.className = 'profile-input';
      
      const bioInput = document.createElement('textarea');
      bioInput.value = bio.innerText;
      bioInput.id = 'bioInput';
      bioInput.className = 'profile-input';
      
      // T·∫°o container cho l·ªãch s·ª≠ username
      const usernameHistoryContainer = document.createElement('div');
      usernameHistoryContainer.id = 'usernameHistoryContainer';
      usernameHistoryContainer.className = 'username-history-container';
      usernameHistoryContainer.innerHTML = '<p>ƒêang t·∫£i l·ªãch s·ª≠ username...</p>';
      
      // Thay th·∫ø c√°c ph·∫ßn t·ª≠
      name.replaceWith(nameInput);
      bio.replaceWith(bioInput);
      
      // Ch√®n container l·ªãch s·ª≠ username sau nameInput
      nameInput.parentNode.insertBefore(usernameHistoryContainer, nameInput.nextSibling);
      
      // C·∫≠p nh·∫≠t n√∫t l∆∞u
      editBtn.innerHTML = 'üíæ';
      
      // L·∫•y l·ªãch s·ª≠ username t·ª´ server
      try {
        const response = await fetch('getUsernameHistory.php');
        const data = await response.json();
        
        if (data.success) {
          let historyContent = '';
          
          // Ki·ªÉm tra c√≥ th·ªÉ ƒë·ªïi username hay kh√¥ng
          if (!data.canChangeUsername) {
            historyContent = `<div class="username-change-restriction">
              <p>‚è∞ B·∫°n c√≥ th·ªÉ ƒë·ªïi username sau ${data.daysRemaining} ng√†y n·ªØa</p>
            </div>`;
            
            // Disable nameInput n·∫øu ch∆∞a ƒë·ªß 90 ng√†y
            nameInput.disabled = true;
            nameInput.title = `B·∫°n ch·ªâ c√≥ th·ªÉ ƒë·ªïi username sau ${data.daysRemaining} ng√†y n·ªØa`;
          }
          
          // Th√™m l·ªãch s·ª≠ username n·∫øu c√≥
          if (data.history.length > 0) {
            historyContent += '<div class="username-history-list"><h4>L·ªãch s·ª≠ username c≈©:</h4><ul>';
            
            data.history.forEach(item => {
              // ƒê·ªãnh d·∫°ng ng√†y th√°ng
              const date = new Date(item.changeDate);
              const formattedDate = date.toLocaleDateString('vi-VN') + ' ' + 
                                   date.toLocaleTimeString('vi-VN');
              
              historyContent += `<li>${formattedDate} - ${item.username}</li>`;
            });
            
            historyContent += '</ul></div>';
          }
          
          // C·∫≠p nh·∫≠t n·ªôi dung container
          if (historyContent) {
            usernameHistoryContainer.innerHTML = historyContent;
          } else {
            usernameHistoryContainer.style.display = 'none';
          }
        } else {
          usernameHistoryContainer.innerHTML = '<p>Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ username</p>';
        }
      } catch (error) {
        console.error('L·ªói khi t·∫£i l·ªãch s·ª≠ username:', error);
        usernameHistoryContainer.innerHTML = '<p>ƒê√£ x·∫£y ra l·ªói khi t·∫£i l·ªãch s·ª≠</p>';
      }
    }

    async function exitEditMode() {
      const nameInput = document.getElementById('nameInput');
      const bioInput = document.getElementById('bioInput');
      const editBtn = document.querySelector('.edit-profile-btn');
      
      // X√≥a container l·ªãch s·ª≠ username
      const usernameHistoryContainer = document.getElementById('usernameHistoryContainer');
      if (usernameHistoryContainer) {
        usernameHistoryContainer.remove();
      }
      
      // L∆∞u gi√° tr·ªã hi·ªán t·∫°i ƒë·ªÉ kh√¥i ph·ª•c n·∫øu c·∫ßn
      const currentNameValue = nameInput.value.trim();
      const currentBioValue = bioInput.value.trim();
      
      // L·∫•y t√™n hi·ªán t·∫°i t·ª´ ph·∫ßn t·ª≠ userName
      const currentUsername = document.getElementById('userName').textContent;
      
      // L·∫•y role hi·ªán t·∫°i ƒë·ªÉ t·∫°o l·∫°i badge
      const userRole = document.getElementById('userName').classList.contains('admin') ? 'admin' : 
                      document.getElementById('userName').classList.contains('customerpre') ? 'customerpre' : 'customer';
      
      // Ki·ªÉm tra n·∫øu username thay ƒë·ªïi
      if (currentNameValue !== currentUsername) {
        try {
          // G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t username
          const response = await fetch('updateUsername.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username: currentNameValue })
          });
          
          const data = await response.json();
          
          if (!data.success) {
            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
            alert(data.message);
            
            // Kh√¥i ph·ª•c t√™n c≈©
            nameInput.value = currentUsername;
            return; // Kh√¥ng tho√°t kh·ªèi ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
          } else {
            // C·∫≠p nh·∫≠t th√†nh c√¥ng, hi·ªÉn th·ªã th√¥ng b√°o
            alert('T√™n ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!');
            
            // C·∫≠p nh·∫≠t t√™n trong to√†n b·ªô giao di·ªán
            document.getElementById('userName').textContent = currentNameValue;
          }
        } catch (error) {
          console.error('L·ªói khi c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng:', error);
          alert('ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng');
          return; // Kh√¥ng tho√°t kh·ªèi ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
        }
      }
      
      // Tho√°t kh·ªèi ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
      document.body.classList.remove('edit-mode');
      
      const name = document.createElement('h2');
      name.id = 'profileName';
      name.innerText = currentNameValue;
      name.classList.add(userRole); // Th√™m l·∫°i class role
      
      const bio = document.createElement('p');
      bio.id = 'profileBio';
      bio.innerText = currentBioValue;
      
      nameInput.replaceWith(name);
      bioInput.replaceWith(bio);
      editBtn.innerHTML = '‚úèÔ∏è';
      
      // Kh√¥i ph·ª•c badge sau khi ch·ªânh s·ª≠a
      setTimeout(() => {
        const usernameContainer = document.querySelector('.username-container');
        if (usernameContainer) {
          // Th√™m l·∫°i badge theo role
          if (userRole === 'admin') {
            const badge = document.createElement('span');
            badge.className = 'role-badge admin';
            badge.textContent = 'ADMIN';
            usernameContainer.appendChild(badge);
          } 
          else if (userRole === 'customerpre') {
            const badge = document.createElement('span');
            badge.className = 'role-badge premium';
            badge.textContent = 'PREMIUM USER';
            usernameContainer.appendChild(badge);
          }
        }
      }, 100);
      

      
      // TODO: L∆∞u bio v√†o server (ch·ª©c nƒÉng n√†y s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn sau)
      console.log('Profile saved:', { name: currentNameValue, bio: currentBioValue });
    }

    async function uploadAvatar(file) {
      if (!file) return;
      
      try {
        // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i l√™n
        const cropButton = document.querySelector('.crop-button');
        const originalButtonText = cropButton.textContent;
        cropButton.textContent = 'ƒêang t·∫£i l√™n...';
        cropButton.disabled = true;
        
        // T·∫°o FormData ƒë·ªÉ g·ª≠i l√™n server
        const formData = new FormData();
        formData.append('avatar', file);
        
        // G·ª≠i d·ªØ li·ªáu l√™n server
        const response = await fetch('uploadAvatar.php', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        // Kh√¥i ph·ª•c n√∫t
        cropButton.textContent = originalButtonText;
        cropButton.disabled = false;
        
        if (data.success) {
          // C·∫≠p nh·∫≠t avatar m·ªõi
          document.getElementById('profileAvatar').src = data.avatarUrl;
          document.getElementById('userAvatar').src = data.avatarUrl;
          
          // C·∫≠p nh·∫≠t avatar trong modal ch√≠nh
          const modalAvatar = document.getElementById('modalAvatar');
          if (modalAvatar) {
            modalAvatar.src = data.avatarUrl;
          }
          
          // ƒê√≥ng t·∫•t c·∫£ modal
          closeAllModals();
          
          // Th√¥ng b√°o th√†nh c√¥ng
          alert('·∫¢nh ƒë·∫°i di·ªán ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng');
        } else {
          // Hi·ªÉn th·ªã l·ªói
          alert('L·ªói khi c·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán: ' + data.message);
        }
      } catch (error) {
        console.error('L·ªói khi t·∫£i l√™n avatar:', error);
        alert('ƒê√£ x·∫£y ra l·ªói khi t·∫£i l√™n ·∫£nh ƒë·∫°i di·ªán');
        document.querySelector('.crop-button').textContent = 'Next';
        document.querySelector('.crop-button').disabled = false;
      }
    }
    
    // Gi·ªØ l·∫°i h√†m changeAvatar c≈© cho tr∆∞·ªùng h·ª£p c·∫ßn d√πng ƒë·∫øn (nh∆∞ng kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng trong UI m·ªõi)
    function changeAvatar() {
      editAvatar();
    }


    function toggleLocation() {
      const checkbox = document.getElementById('location');
      checkbox.checked = !checkbox.checked;
      console.log('Location:', checkbox.checked);
    }

    function showAboutUs() {
      alert('Th√¥ng tin v·ªÅ ·ª©ng d·ª•ng s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn trong phi√™n b·∫£n ti·∫øp theo');
    }
    
    function showEditProfileModal() {
      // C·∫≠p nh·∫≠t th√¥ng tin trong modal
      const profileAvatar = document.getElementById('profileAvatar').src;
      const profileName = document.getElementById('profileName').textContent;
      
      document.getElementById('modalAvatar').src = profileAvatar;
      document.getElementById('modalUsername').textContent = profileName;
      
      // Hi·ªÉn th·ªã modal v√† backdrop
      document.getElementById('modalBackdrop').style.display = 'block';
      document.getElementById('editProfileModal').style.display = 'flex';
    }
    
    function closeEditProfileModal() {
      document.getElementById('modalBackdrop').style.display = 'none';
      document.getElementById('editProfileModal').style.display = 'none';
    }
    
    function editUsername() {
      // ·∫®n modal ch·ªânh s·ª≠a ch√≠nh
      document.getElementById('editProfileModal').style.display = 'none';
      
      // Hi·ªán modal ch·ªânh s·ª≠a t√™n
      const usernameModal = document.getElementById('usernameEditModal');
      const currentName = document.getElementById('modalUsername').textContent;
      document.getElementById('newUsername').value = currentName;
      
      // Reset th√¥ng b√°o l·ªói
      const errorElement = document.getElementById('usernameError');
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.style.display = 'none';
      }
      
      usernameModal.style.display = 'flex';
    }
    
    function backToMainEditModal() {
      // ·∫®n modal ch·ªânh s·ª≠a t√™n
      document.getElementById('usernameEditModal').style.display = 'none';
      
      // Reset th√¥ng b√°o l·ªói
      const errorElement = document.getElementById('usernameError');
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.style.display = 'none';
      }
      
      // Hi·ªán l·∫°i modal ch·ªânh s·ª≠a ch√≠nh
      document.getElementById('editProfileModal').style.display = 'flex';
    }
    
    function closeAllModals() {
      document.getElementById('usernameEditModal').style.display = 'none';
      document.getElementById('editProfileModal').style.display = 'none';
      document.getElementById('avatarCropModal').style.display = 'none';
      document.getElementById('modalBackdrop').style.display = 'none';
      
      // Reset th√¥ng b√°o l·ªói n·∫øu c√≥
      const errorElement = document.getElementById('usernameError');
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.style.display = 'none';
      }
      
      // X√≥a ·∫£nh ƒë√£ ch·ªçn n·∫øu c√≥
      if (croppedImageUrl) {
        URL.revokeObjectURL(croppedImageUrl);
        croppedImageUrl = null;
      }
      selectedImageFile = null;
    }
    
    function saveUsername() {
      const newName = document.getElementById('newUsername').value.trim();
      const errorElement = document.getElementById('usernameError');
      
      if (newName !== '') {
        // ·∫®n th√¥ng b√°o l·ªói n·∫øu c√≥
        errorElement.style.display = 'none';
        // G·ª≠i request c·∫≠p nh·∫≠t t√™n
        updateUsername(newName);
      } else {
        // Hi·ªÉn th·ªã l·ªói trong modal
        errorElement.textContent = 'T√™n ng∆∞·ªùi d√πng kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng';
        errorElement.style.display = 'block';
      }
    }
    
    async function updateUsername(newName) {
      try {
        const errorElement = document.getElementById('usernameError');
        
        // G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t username
        const response = await fetch('updateUsername.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ username: newName })
        });
        
        const data = await response.json();
        
        if (!data.success) {
          // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói trong modal
          errorElement.textContent = data.message;
          errorElement.style.display = 'block';
        } else {
          // C·∫≠p nh·∫≠t th√†nh c√¥ng
          // C·∫≠p nh·∫≠t t√™n trong to√†n b·ªô giao di·ªán
          document.getElementById('userName').textContent = newName;
          document.getElementById('profileName').textContent = newName;
          document.getElementById('modalUsername').textContent = newName;
          
          // ƒê√≥ng t·∫•t c·∫£ c√°c modal
          closeAllModals();
          
          // Th√¥ng b√°o th√†nh c√¥ng
          alert('T√™n ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!');
        }
      } catch (error) {
        console.error('L·ªói khi c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng:', error);
        document.getElementById('usernameError').textContent = 'ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng';
        document.getElementById('usernameError').style.display = 'block';
      }
    }
    
    // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu ·∫£nh
    let selectedImageFile = null;
    let croppedImageUrl = null;
    
    function editAvatar() {
      // M·ªü input ƒë·ªÉ ch·ªçn file
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/jpeg,image/png,image/gif';
      input.onchange = handleAvatarFileSelect;
      input.click();
    }
    
    function handleAvatarFileSelect(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (gi·ªõi h·∫°n 2MB)
      if (file.size > 2 * 1024 * 1024) {
        alert('K√≠ch th∆∞·ªõc file qu√° l·ªõn. Gi·ªõi h·∫°n 2MB');
        return;
      }
      
      selectedImageFile = file;
      
      // T·∫°o URL cho ·∫£nh ƒë√£ ch·ªçn
      const imageUrl = URL.createObjectURL(file);
      
      // Hi·ªÉn th·ªã ·∫£nh trong modal crop
      document.getElementById('cropPreviewImg').src = imageUrl;
      
      // ·∫®n modal ch·ªânh s·ª≠a th√¥ng tin v√† hi·ªán modal crop
      document.getElementById('editProfileModal').style.display = 'none';
      document.getElementById('avatarCropModal').style.display = 'flex';
    }
    
    function backFromCropModal() {
      // ·∫®n modal crop v√† hi·ªán l·∫°i modal ch·ªânh s·ª≠a
      document.getElementById('avatarCropModal').style.display = 'none';
      document.getElementById('editProfileModal').style.display = 'flex';
      
      // X√≥a ·∫£nh ƒë√£ ch·ªçn
      if (croppedImageUrl) {
        URL.revokeObjectURL(croppedImageUrl);
        croppedImageUrl = null;
      }
    }
    
    function saveCroppedAvatar() {
      if (!selectedImageFile) return;
      
      // L∆∞u √Ω: Trong th·ª±c t·∫ø, b·∫°n n√™n s·ª≠ d·ª•ng th∆∞ vi·ªán nh∆∞ Cropper.js ƒë·ªÉ c·∫Øt ·∫£nh
      // ·ªû ƒë√¢y ch√∫ng ta ch·ªâ gi·∫£ l·∫≠p vi·ªác crop b·∫±ng c√°ch s·ª≠ d·ª•ng ·∫£nh ƒë√£ ch·ªçn m√† kh√¥ng c·∫Øt
      uploadAvatar(selectedImageFile);
    }

    function logout() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        // Clear all client-side storage
        sessionStorage.clear();
        localStorage.clear();
        
        // Clear any cookies (optional, for completeness)
        document.cookie.split(";").forEach(function(c) { 
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
        });
        
        // Redirect to logout.php to clear server-side session
        window.location.href = '../logout.php';
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadUserInfo();
      console.log('Profile page loaded');
    });
    
    // Update stats cards with real data
    function updateStatsCards(stats, userScore) {
      const statsSection = document.getElementById('statsSection');
      if (!statsSection) return;
      
      console.log('Updating stats:', stats); // Debug log
      
      // Create stats cards dynamically - h√†ng ngang compact
      statsSection.innerHTML = `
        <div class="stat-card">
          <div class="stat-number">${userScore || 0}</div>
          <div class="stat-label">ƒêi·ªÉm</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${stats.totalCheckins || 0}</div>
          <div class="stat-label">Check-ins</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">${stats.museumVisited || 0}</div>
          <div class="stat-label">B·∫£o t√†ng</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">#${stats.leaderboardPosition || 'N/A'}</div>
          <div class="stat-label">X·∫øp h·∫°ng</div>
        </div>
      `;
    }
    
    // Update achievements section with real data
    function updateAchievementsSection(recentAchievements) {
      const achievementGrid = document.getElementById('achievementGrid');
      if (!achievementGrid) return;
      
      // Clear existing achievements
      achievementGrid.innerHTML = '';
      
      // Show recent achievements (max 4)
      const achievementsToShow = recentAchievements.slice(0, 4);
      
      achievementsToShow.forEach(achievement => {
        const achievementCard = document.createElement('div');
        achievementCard.className = 'achievement-card earned';
        achievementCard.innerHTML = `
          <div class="achievement-icon">${achievement.Icon}</div>
          <div class="achievement-name">${achievement.NameVi}</div>
          <div class="achievement-desc">+${achievement.Points} ƒëi·ªÉm</div>
        `;
        achievementGrid.appendChild(achievementCard);
      });
      
      // Add placeholder cards if less than 4 achievements
      while (achievementGrid.children.length < 4) {
        const placeholderCard = document.createElement('div');
        placeholderCard.className = 'achievement-card';
        placeholderCard.innerHTML = `
          <div class="achievement-icon">üîí</div>
          <div class="achievement-name">Kh√≥a</div>
          <div class="achievement-desc">Ch∆∞a m·ªü kh√≥a</div>
        `;
        achievementGrid.appendChild(placeholderCard);
      }
    }
    
    // Update activities section with real data
    function updateActivitiesSection(recentActivities) {
      const activityList = document.getElementById('activityList');
      if (!activityList) return;
      
      // Clear existing activities
      activityList.innerHTML = '';
      
      if (recentActivities.length === 0) {
        activityList.innerHTML = `
          <div class="activity-item">
            <div class="activity-icon">üìã</div>
            <div class="activity-info">
              <p><strong>Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</strong></p>
              <p class="activity-time">H√£y b·∫Øt ƒë·∫ßu b·∫±ng vi·ªác check-in!</p>
            </div>
          </div>
        `;
        return;
      }
      
      recentActivities.forEach(activity => {
        const activityItem = document.createElement('div');
        activityItem.className = 'activity-item';
        
        const pointsHtml = activity.Points > 0 ? 
          `<div class="activity-points">+${activity.Points}</div>` : '';
        
        activityItem.innerHTML = `
          <div class="activity-icon">${activity.Icon}</div>
          <div class="activity-info">
            <p><strong>${activity.Title}</strong></p>
            <p class="activity-time">${activity.timeAgo}</p>
          </div>
          ${pointsHtml}
        `;
        
        activityList.appendChild(activityItem);
      });
    }
  </script>

  <!-- Lucky Coin Notification -->
  <script src="/lucky_coin/lucky_coin_notification.js"></script>
</body>
</html>