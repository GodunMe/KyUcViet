<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Profile - Vietnamese Memories</title>
  <link rel="icon" type="image/png" href="../logo.PNG" />
  <link rel="stylesheet" href="../style.css" />
  <style>
    /* C·∫£i ti·∫øn giao di·ªán profile header */
    .profile-header {
      background: linear-gradient(135deg, rgba(94, 53, 177, 0.9), rgba(103, 58, 183, 0.85));
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }

    .profile-header-content {
      display: flex;
      align-items: flex-start;
    }

    .profile-avatar {
      position: relative;
      margin-right: 15px;
    }

    .profile-avatar img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid rgba(255, 255, 255, 0.3);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .change-avatar-btn {
      position: absolute;
      bottom: 0;
      right: 0;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      justify-content: center;
      align-items: center;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }

    .profile-info {
      flex: 1;
    }

    .profile-info-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .username-container {
      display: flex;
      align-items: center;
    }

    .profile-info h2 {
      margin: 0;
      color: white;
      font-size: 24px;
      display: inline-block;
      padding: 3px 10px;
      border-radius: 12px;
    }

    .profile-points {
      color: rgba(255, 255, 255, 0.9);
      font-size: 16px;
      margin: 2px 0 8px 10px;
    }

    .profile-info p {
      margin: 5px 0 0 10px;
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
    }

    .edit-profile-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      width: 35px;
      height: 35px;
      min-width: 35px; /* ƒê·∫£m b·∫£o kh√¥ng b·ªã co l·∫°i */
      cursor: pointer;
      font-size: 16px;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: all 0.2s;
      margin-left: 10px;
    }

    .edit-profile-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }
    
    /* Style cho n√∫t l∆∞u khi ƒëang ch·ªânh s·ª≠a */
    .edit-mode .edit-profile-btn {
      background: rgba(46, 204, 113, 0.7);
      border-color: rgba(46, 204, 113, 0.8);
    }
    
    .edit-mode .edit-profile-btn:hover {
      background: rgba(46, 204, 113, 0.9);
    }

    /* ·∫®n header ·ªü tr√™n */
    .user-header {
      display: none !important;
    }
    
    /* Style cho ch·∫ø ƒë·ªô ch·ªânh s·ª≠a */
    .profile-input {
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.5);
      border-radius: 6px;
      padding: 8px;
      font-size: 16px;
      margin-bottom: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    
    #bioInput {
      min-height: 80px;
      resize: vertical;
    }
    
    .username-history-container {
      margin: 10px 0;
      padding: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: white;
      font-size: 14px;
    }


    
    /* Username container styling */
    .username-container {
      display: flex;
      align-items: center;
      position: relative;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- User Header -->
    <div class="user-header" id="userHeader">
      <!-- User logged in state -->
      <div id="userLoggedIn" class="user-logged-in" style="display: none;">
        <div class="user-info">
          <img id="userAvatar" src="../avatar/default.png" alt="User" class="user-icon">
          <span id="userName" class="user-name">Loading...</span>
        </div>
        <div class="user-points">
          <span id="userPoints">0ƒë</span>
        </div>
      </div>
      
      <!-- User not logged in state -->
      <div id="usernotLoggedIn" class="user-not-logged-in" style="display: none;">
        <div class="login-prompt">
          <span class="login-text">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem th√¥ng tin c√° nh√¢n</span>
        </div>
        <button class="login-btn" onclick="goToLogin()">
          üîë ƒêƒÉng nh·∫≠p
        </button>
      </div>
    </div>

    <!-- Profile Header -->
    <div class="profile-header">
      <div class="profile-header-content">
        <div class="profile-avatar">
          <img src="../avatar/default.png" alt="User Avatar" id="profileAvatar">
          <button class="change-avatar-btn" onclick="changeAvatar()">üì∑</button>
        </div>
        <div class="profile-info">
          <div class="profile-info-top">
            <div class="username-container">
              <h2 id="profileName">Nguyen Van A</h2>
            </div>
            <button class="edit-profile-btn" onclick="toggleEditMode()" title="Ch·ªânh s·ª≠a">‚úèÔ∏è</button>
          </div>
          <div class="profile-points"><span id="profilePoints">0 ƒëi·ªÉm</span></div>
          <p id="profileBio">Ng∆∞·ªùi ƒëam m√™ kh√°m ph√° vƒÉn h√≥a Vi·ªát Nam</p>
        </div>
      </div>
    </div>

    <!-- Stats Section -->
    <div class="stats-section">
      <div class="stat-card">
        <div class="stat-number">189</div>
        <div class="stat-label">ƒêi·ªÉm</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">8</div>
        <div class="stat-label">Check-ins</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">5</div>
        <div class="stat-label">B·∫£o t√†ng</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">#7</div>
        <div class="stat-label">X·∫øp h·∫°ng</div>
      </div>
    </div>

    <!-- Achievement Section -->
    <div class="achievement-section">
      <h3>üèÖ Th√†nh t√≠ch</h3>
      <div class="achievement-grid">
        <div class="achievement-card earned">
          <div class="achievement-icon">üèõÔ∏è</div>
          <div class="achievement-name">Kh√°m ph√° ƒë·∫ßu ti√™n</div>
          <div class="achievement-desc">Check-in l·∫ßn ƒë·∫ßu</div>
        </div>
        <div class="achievement-card earned">
          <div class="achievement-icon">üìç</div>
          <div class="achievement-name">Th√°m hi·ªÉm</div>
          <div class="achievement-desc">5 check-ins</div>
        </div>
        <div class="achievement-card">
          <div class="achievement-icon">üéØ</div>
          <div class="achievement-name">Chuy√™n gia</div>
          <div class="achievement-desc">10 check-ins</div>
        </div>
        <div class="achievement-card">
          <div class="achievement-icon">üëë</div>
          <div class="achievement-name">B·∫≠c th·∫ßy</div>
          <div class="achievement-desc">Top 3 tu·∫ßn</div>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="activity-section">
      <h3>üìã Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h3>
      <div class="activity-list">
        <div class="activity-item">
          <div class="activity-icon">üìç</div>
          <div class="activity-info">
            <p><strong>Check-in t·∫°i B·∫£o t√†ng H·ªì Ch√≠ Minh</strong></p>
            <p class="activity-time">H√¥m nay, 14:30</p>
          </div>
          <div class="activity-points">+25</div>
        </div>
        <div class="activity-item">
          <div class="activity-icon">üèÜ</div>
          <div class="activity-info">
            <p><strong>L√™n h·∫°ng 7</strong></p>
            <p class="activity-time">H√¥m nay, 14:31</p>
          </div>
        </div>
        <div class="activity-item">
          <div class="activity-icon">üìç</div>
          <div class="activity-info">
            <p><strong>Check-in t·∫°i B·∫£o t√†ng L·ªãch s·ª≠ Qu√¢n s·ª±</strong></p>
            <p class="activity-time">H√¥m qua, 10:15</p>
          </div>
          <div class="activity-points">+30</div>
        </div>
        <div class="activity-item">
          <div class="activity-icon">üèÖ</div>
          <div class="activity-info">
            <p><strong>Nh·∫≠n th√†nh t√≠ch "Th√°m hi·ªÉm"</strong></p>
            <p class="activity-time">H√¥m qua, 10:16</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Section -->
    <div class="settings-section">
      <h3>‚öôÔ∏è C√†i ƒë·∫∑t</h3>
      <div class="settings-list">
        <div class="setting-item" onclick="toggleNotifications()">
          <div class="setting-info">
            <div class="setting-name">Th√¥ng b√°o</div>
            <div class="setting-desc">Nh·∫≠n th√¥ng b√°o v·ªÅ ho·∫°t ƒë·ªông m·ªõi</div>
          </div>
          <div class="setting-toggle">
            <input type="checkbox" id="notifications" checked>
            <label for="notifications" class="toggle-switch"></label>
          </div>
        </div>
        <div class="setting-item" onclick="toggleLocation()">
          <div class="setting-info">
            <div class="setting-name">V·ªã tr√≠</div>
            <div class="setting-desc">Cho ph√©p truy c·∫≠p v·ªã tr√≠</div>
          </div>
          <div class="setting-toggle">
            <input type="checkbox" id="location" checked>
            <label for="location" class="toggle-switch"></label>
          </div>
        </div>
        <div class="setting-item" onclick="showPrivacySettings()">
          <div class="setting-info">
            <div class="setting-name">Quy·ªÅn ri√™ng t∆∞</div>
            <div class="setting-desc">Qu·∫£n l√Ω quy·ªÅn ri√™ng t∆∞</div>
          </div>
          <div class="setting-arrow">‚ñ∂</div>
        </div>
        <div class="setting-item logout-item" onclick="logout()">
          <div class="setting-info">
            <div class="setting-name">ƒêƒÉng xu·∫•t</div>
            <div class="setting-desc">Tho√°t kh·ªèi t√†i kho·∫£n</div>
          </div>
          <div class="setting-arrow">üö™</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item" onclick="navigateToPage('home')">
      <div class="nav-icon">üè†</div>
      <div class="nav-label">Home</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('map')">
      <div class="nav-icon">üó∫Ô∏è</div>
      <div class="nav-label">Map</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('checkin')">
      <div class="nav-icon">üìç</div>
      <div class="nav-label">Check-in</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('leaderboard')">
      <div class="nav-icon">üèÜ</div>
      <div class="nav-label">B·∫£ng x·∫øp h·∫°ng</div>
    </div>
    <div class="nav-item active" onclick="navigateToPage('profile')">
      <div class="nav-icon">üë§</div>
      <div class="nav-label">Profile</div>
    </div>
  </div>

  <script>
    // Load user info on page load
    async function loadUserInfo() {
      try {
        const response = await fetch('getUserInfo.php');
        if (response.ok) {
          const data = await response.json();
          
          if (data.loggedIn) {
            showUserLoggedInState(data);
          } else {
            showUserNotLoggedInState();
          }
        } else {
          showUserNotLoggedInState();
        }
      } catch (error) {
        console.error('Error loading user info:', error);
        showUserNotLoggedInState();
      }
    }


    
    function showUserLoggedInState(userData) {
      const loggedInDiv = document.getElementById('userLoggedIn');
      const notLoggedInDiv = document.getElementById('usernotLoggedIn');
      
      // Show logged in state, hide not logged in state
      loggedInDiv.style.display = 'flex';
      notLoggedInDiv.style.display = 'none';
      
      // Update user avatar
      const avatarElement = document.getElementById('userAvatar');
      avatarElement.src = userData.avatarRelative || '../avatar/default.png';
      
      // Update user name
      const nameElement = document.getElementById('userName');
      nameElement.textContent = userData.username || 'Guest User';
      
      // Update user points
      const pointsElement = document.getElementById('userPoints');
      pointsElement.textContent = (userData.score || 0) + 'ƒë';
      
      // Update profile points
      const profilePointsElement = document.getElementById('profilePoints');
      if (profilePointsElement) {
        profilePointsElement.textContent = (userData.score || 0) + ' ƒëi·ªÉm';
      }
      
      // Th√™m verified badge d·ª±a tr√™n role
      const userRole = userData.role ? userData.role.toLowerCase() : 'customer';
      console.log('User role:', userRole);
      
      // Update profile information
      const profileName = document.getElementById('profileName');
      if (profileName) {
        profileName.textContent = userData.username || 'Guest User';
        // Remove any existing role classes from profile name
        profileName.classList.remove('admin', 'customerpre', 'customer');
      }
      
      const profileAvatar = document.getElementById('profileAvatar');
      if (profileAvatar) profileAvatar.src = userData.avatarRelative || '../avatar/default.png';
      
      // Apply role-based styling
      // First, remove any existing role classes
      nameElement.classList.remove('admin', 'customerpre', 'customer');
      avatarElement.classList.remove('admin', 'customerpre', 'customer');
      
      if (profileAvatar) {
        const profileAvatarContainer = document.querySelector('.profile-avatar');
        if (profileAvatarContainer) {
          profileAvatarContainer.classList.remove('admin', 'customerpre', 'customer');
        }
      }
      
      // Then apply the appropriate class based on user's role
      // Add appropriate class based on role
      nameElement.classList.add(userRole);
      avatarElement.classList.add(userRole);
      
      // Th√™m class role v√†o profileName ƒë·ªÉ c√≥ c√πng style v·ªõi userName
      if (profileName) profileName.classList.add(userRole);
      
      if (profileAvatar) {
        const profileAvatarContainer = document.querySelector('.profile-avatar');
        if (profileAvatarContainer) {
          profileAvatarContainer.classList.add(userRole);
        }
      }
      
      console.log('Applied styling for role:', userRole);
    }

    function showUserNotLoggedInState() {
      const loggedInDiv = document.getElementById('userLoggedIn');
      const notLoggedInDiv = document.getElementById('usernotLoggedIn');
      
      // Show not logged in state, hide logged in state
      loggedInDiv.style.display = 'none';
      notLoggedInDiv.style.display = 'flex';
    }

    function goToLogin() {
  // Ki·ªÉm tra xem c√≥ token kh√¥ng (c√≥ th·ªÉ t·ª´ localStorage, sessionStorage, ho·∫∑c URL parameter)
  const urlParams = new URLSearchParams(window.location.search);
  const tokenFromUrl = urlParams.get('token');
  const tokenFromStorage = localStorage.getItem('nfc_token') || sessionStorage.getItem('nfc_token');
  
  if (tokenFromUrl || tokenFromStorage) {
    // C√≥ token, chuy·ªÉn ƒë·∫øn trang login
    const token = tokenFromUrl || tokenFromStorage;
    window.location.href = `../login.php?token=${token}`;
  } else {
    // Kh√¥ng c√≥ token, chuy·ªÉn ƒë·∫øn trang th√¥ng b√°o NFC
    window.location.href = '../nfc_required.html';
  }
}

    // Navigation functions
    function navigateToPage(page) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      event.target.closest('.nav-item').classList.add('active');
      
      switch(page) {
        case 'home':
          window.location.href = '../index.php';
          break;
        case 'map':
          window.location.href = '../map.html';
          break;
        case 'checkin':
          window.location.href = '../checkin/checkin.html';
          break;
        case 'leaderboard':
          window.location.href = '../leaderboard.html';
          break;
        case 'profile':
          // Already on profile page
          break;
      }
    }

    // Profile functions
    function toggleEditMode() {
      const isEditing = document.querySelector('.edit-mode');
      if (isEditing) {
        exitEditMode();
      } else {
        enterEditMode();
      }
    }

    async function enterEditMode() {
      document.body.classList.add('edit-mode');
      const name = document.getElementById('profileName');
      const bio = document.getElementById('profileBio');
      const editBtn = document.querySelector('.edit-profile-btn');
      
      // L·∫•y v√† l∆∞u tr·ªØ role ƒë·ªÉ d√πng sau khi tho√°t ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
      const userRole = name.classList.contains('admin') ? 'admin' : 
                      name.classList.contains('customerpre') ? 'customerpre' : 'customer';
      
      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.value = name.innerText;
      nameInput.id = 'nameInput';
      nameInput.className = 'profile-input';
      
      const bioInput = document.createElement('textarea');
      bioInput.value = bio.innerText;
      bioInput.id = 'bioInput';
      bioInput.className = 'profile-input';
      
      // T·∫°o container cho l·ªãch s·ª≠ username
      const usernameHistoryContainer = document.createElement('div');
      usernameHistoryContainer.id = 'usernameHistoryContainer';
      usernameHistoryContainer.className = 'username-history-container';
      usernameHistoryContainer.innerHTML = '<p>ƒêang t·∫£i l·ªãch s·ª≠ username...</p>';
      
      // Thay th·∫ø c√°c ph·∫ßn t·ª≠
      name.replaceWith(nameInput);
      bio.replaceWith(bioInput);
      
      // Ch√®n container l·ªãch s·ª≠ username sau nameInput
      nameInput.parentNode.insertBefore(usernameHistoryContainer, nameInput.nextSibling);
      
      // C·∫≠p nh·∫≠t n√∫t l∆∞u
      editBtn.innerHTML = 'üíæ';
      
      // L·∫•y l·ªãch s·ª≠ username t·ª´ server
      try {
        const response = await fetch('getUsernameHistory.php');
        const data = await response.json();
        
        if (data.success) {
          let historyContent = '';
          
          // Ki·ªÉm tra c√≥ th·ªÉ ƒë·ªïi username hay kh√¥ng
          if (!data.canChangeUsername) {
            historyContent = `<div class="username-change-restriction">
              <p>‚è∞ B·∫°n c√≥ th·ªÉ ƒë·ªïi username sau ${data.daysRemaining} ng√†y n·ªØa</p>
            </div>`;
            
            // Disable nameInput n·∫øu ch∆∞a ƒë·ªß 90 ng√†y
            nameInput.disabled = true;
            nameInput.title = `B·∫°n ch·ªâ c√≥ th·ªÉ ƒë·ªïi username sau ${data.daysRemaining} ng√†y n·ªØa`;
          }
          
          // Th√™m l·ªãch s·ª≠ username n·∫øu c√≥
          if (data.history.length > 0) {
            historyContent += '<div class="username-history-list"><h4>L·ªãch s·ª≠ username c≈©:</h4><ul>';
            
            data.history.forEach(item => {
              // ƒê·ªãnh d·∫°ng ng√†y th√°ng
              const date = new Date(item.changeDate);
              const formattedDate = date.toLocaleDateString('vi-VN') + ' ' + 
                                   date.toLocaleTimeString('vi-VN');
              
              historyContent += `<li>${formattedDate} - ${item.username}</li>`;
            });
            
            historyContent += '</ul></div>';
          }
          
          // C·∫≠p nh·∫≠t n·ªôi dung container
          if (historyContent) {
            usernameHistoryContainer.innerHTML = historyContent;
          } else {
            usernameHistoryContainer.style.display = 'none';
          }
        } else {
          usernameHistoryContainer.innerHTML = '<p>Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ username</p>';
        }
      } catch (error) {
        console.error('L·ªói khi t·∫£i l·ªãch s·ª≠ username:', error);
        usernameHistoryContainer.innerHTML = '<p>ƒê√£ x·∫£y ra l·ªói khi t·∫£i l·ªãch s·ª≠</p>';
      }
    }

    async function exitEditMode() {
      const nameInput = document.getElementById('nameInput');
      const bioInput = document.getElementById('bioInput');
      const editBtn = document.querySelector('.edit-profile-btn');
      
      // X√≥a container l·ªãch s·ª≠ username
      const usernameHistoryContainer = document.getElementById('usernameHistoryContainer');
      if (usernameHistoryContainer) {
        usernameHistoryContainer.remove();
      }
      
      // L∆∞u gi√° tr·ªã hi·ªán t·∫°i ƒë·ªÉ kh√¥i ph·ª•c n·∫øu c·∫ßn
      const currentNameValue = nameInput.value.trim();
      const currentBioValue = bioInput.value.trim();
      
      // L·∫•y t√™n hi·ªán t·∫°i t·ª´ ph·∫ßn t·ª≠ userName
      const currentUsername = document.getElementById('userName').textContent;
      
      // L·∫•y role hi·ªán t·∫°i ƒë·ªÉ t·∫°o l·∫°i badge
      const userRole = document.getElementById('userName').classList.contains('admin') ? 'admin' : 
                      document.getElementById('userName').classList.contains('customerpre') ? 'customerpre' : 'customer';
      
      // Ki·ªÉm tra n·∫øu username thay ƒë·ªïi
      if (currentNameValue !== currentUsername) {
        try {
          // G·ª≠i y√™u c·∫ßu c·∫≠p nh·∫≠t username
          const response = await fetch('updateUsername.php', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ username: currentNameValue })
          });
          
          const data = await response.json();
          
          if (!data.success) {
            // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
            alert(data.message);
            
            // Kh√¥i ph·ª•c t√™n c≈©
            nameInput.value = currentUsername;
            return; // Kh√¥ng tho√°t kh·ªèi ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
          } else {
            // C·∫≠p nh·∫≠t th√†nh c√¥ng, hi·ªÉn th·ªã th√¥ng b√°o
            alert('T√™n ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!');
            
            // C·∫≠p nh·∫≠t t√™n trong to√†n b·ªô giao di·ªán
            document.getElementById('userName').textContent = currentNameValue;
          }
        } catch (error) {
          console.error('L·ªói khi c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng:', error);
          alert('ƒê√£ x·∫£y ra l·ªói khi c·∫≠p nh·∫≠t t√™n ng∆∞·ªùi d√πng');
          return; // Kh√¥ng tho√°t kh·ªèi ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
        }
      }
      
      // Tho√°t kh·ªèi ch·∫ø ƒë·ªô ch·ªânh s·ª≠a
      document.body.classList.remove('edit-mode');
      
      const name = document.createElement('h2');
      name.id = 'profileName';
      name.innerText = currentNameValue;
      name.classList.add(userRole); // Th√™m l·∫°i class role
      
      const bio = document.createElement('p');
      bio.id = 'profileBio';
      bio.innerText = currentBioValue;
      
      nameInput.replaceWith(name);
      bioInput.replaceWith(bio);
      editBtn.innerHTML = '‚úèÔ∏è';
      

      
      // TODO: L∆∞u bio v√†o server (ch·ª©c nƒÉng n√†y s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn sau)
      console.log('Profile saved:', { name: currentNameValue, bio: currentBioValue });
    }

    function changeAvatar() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/jpeg,image/png,image/gif';
      input.onchange = async function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Ki·ªÉm tra k√≠ch th∆∞·ªõc file (gi·ªõi h·∫°n 2MB)
        if (file.size > 2 * 1024 * 1024) {
          alert('K√≠ch th∆∞·ªõc file qu√° l·ªõn. Gi·ªõi h·∫°n 2MB');
          return;
        }
        
        // Hi·ªÉn th·ªã tr∆∞·ªõc ·∫£nh
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('profileAvatar').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // T·∫°o FormData ƒë·ªÉ g·ª≠i l√™n server
        const formData = new FormData();
        formData.append('avatar', file);
        
        try {
          // Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang t·∫£i l√™n
          const profileAvatar = document.getElementById('profileAvatar');
          const originalSrc = profileAvatar.src;
          const originalStyle = profileAvatar.style.opacity;
          profileAvatar.style.opacity = '0.5';
          
          // G·ª≠i d·ªØ li·ªáu l√™n server
          const response = await fetch('uploadAvatar.php', {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          
          // Kh√¥i ph·ª•c tr·∫°ng th√°i avatar
          profileAvatar.style.opacity = originalStyle;
          
          if (data.success) {
            // C·∫≠p nh·∫≠t avatar m·ªõi
            document.getElementById('profileAvatar').src = data.avatarUrl;
            document.getElementById('userAvatar').src = data.avatarUrl;
            
            // Th√¥ng b√°o th√†nh c√¥ng
            alert('·∫¢nh ƒë·∫°i di·ªán ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng');
          } else {
            // Hi·ªÉn th·ªã l·ªói v√† kh√¥i ph·ª•c avatar c≈©
            alert('L·ªói khi c·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán: ' + data.message);
            document.getElementById('profileAvatar').src = originalSrc;
          }
        } catch (error) {
          console.error('L·ªói khi t·∫£i l√™n avatar:', error);
          alert('ƒê√£ x·∫£y ra l·ªói khi t·∫£i l√™n ·∫£nh ƒë·∫°i di·ªán');
          // Kh√¥i ph·ª•c tr·∫°ng th√°i avatar
          document.getElementById('profileAvatar').style.opacity = originalStyle;
        }
      };
      input.click();
    }

    function toggleNotifications() {
      const checkbox = document.getElementById('notifications');
      checkbox.checked = !checkbox.checked;
      console.log('Notifications:', checkbox.checked);
    }

    function toggleLocation() {
      const checkbox = document.getElementById('location');
      checkbox.checked = !checkbox.checked;
      console.log('Location:', checkbox.checked);
    }

    function showPrivacySettings() {
      alert('C√†i ƒë·∫∑t quy·ªÅn ri√™ng t∆∞ s·∫Ω ƒë∆∞·ª£c ph√°t tri·ªÉn trong phi√™n b·∫£n ti·∫øp theo');
    }

    function logout() {
      if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) {
        // Clear all client-side storage
        sessionStorage.clear();
        localStorage.clear();
        
        // Clear any cookies (optional, for completeness)
        document.cookie.split(";").forEach(function(c) { 
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
        });
        
        // Redirect to logout.php to clear server-side session
        window.location.href = '../logout.php';
      }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadUserInfo();
      console.log('Profile page loaded');
    });
  </script>
</body>
</html>