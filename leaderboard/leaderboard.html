<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>B·∫£ng x·∫øp h·∫°ng - Vietnamese Memories</title>
  <link rel="icon" type="image/png" href="logo.PNG" />
  <link rel="stylesheet" href="../style.css" />
  <!-- head-level styles removed; styles are in style.css -->
</head>

<body>
  <div class="container">
    <!-- User Header -->
    <div class="user-header" id="userHeader">
      <!-- User logged in state -->
      <div id="userLoggedIn" class="user-logged-in" style="display: none;">
        <div class="user-info">
          <img id="userAvatar" src="avatar/default.png" alt="User" class="user-icon">
          <span id="userName" class="user-name">Loading...</span>
        </div>
        <div class="user-points">
          <span id="userPoints">0ƒë</span>
        </div>
      </div>

      <!-- User not logged in state -->
      <div id="usernotLoggedIn" class="user-not-logged-in" style="display: none;">
        <div class="login-prompt">
          <span class="login-text">ƒêƒÉng nh·∫≠p ƒë·ªÉ xem b·∫£ng x·∫øp h·∫°ng</span>
        </div>
        <button class="login-btn" onclick="goToLogin()">
          üîë ƒêƒÉng nh·∫≠p
        </button>
      </div>
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <h1>üèÜ B·∫£ng x·∫øp h·∫°ng</h1>
      <p>Xem th·ª© h·∫°ng c·ªßa b·∫°n v√† c·∫°nh tranh v·ªõi nh·ªØng ng∆∞·ªùi kh√°m ph√° kh√°c</p>
    </div>
    <!-- User Rank Card -->
    <div class="user-rank-card">
      <div class="rank-badge">#--</div>

      <div class="user-info-rank">
        <img src="../avatar/default.png" alt="User" class="rank-avatar">
        <div>
          <h3>ƒêang t·∫£i...</h3>
          <p>0 ƒëi·ªÉm</p>
        </div>
      </div>

      <div class="rank-progress">
        <div class="progress-bar">
          <div class="progress-fill" style="width: 0%;"></div>
        </div>
        <p>ƒêang t·∫£i...</p>
      </div>
    </div>

    <!-- Leaderboard List -->
    <div id="leaderboardList" class="leaderboard-list"></div>

  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item" onclick="navigateToPage('home')">
      <div class="nav-icon">üè†</div>
      <div class="nav-label">Home</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('map')">
      <div class="nav-icon">üó∫Ô∏è</div>
      <div class="nav-label">Map</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('checkin')">
      <div class="nav-icon">üìç</div>
      <div class="nav-label">Check-in</div>
    </div>
    <div class="nav-item active" onclick="navigateToPage('leaderboard')">
      <div class="nav-icon">üèÜ</div>
      <div class="nav-label">B·∫£ng x·∫øp h·∫°ng</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('profile')">
      <div class="nav-icon">üë§</div>
      <div class="nav-label">Profile</div>
    </div>
  </div>

  <script>
    // Load user info on page load and store global user state
    async function loadUserInfo() {
      try {
        const response = await fetch('../getUserInfo.php'); // same-origin PHP endpoint
        if (response.ok) {
          const data = await response.json();

          // store global state for leaderboard rendering
          window.currentUserLoggedIn = !!data.loggedIn;
          window.currentUsername = data.username || null;
          window.currentUserRole = data.role || null;

          if (data.loggedIn) {
            showUserLoggedInState(data);
            // populate the user rank card after we confirmed logged-in
            try { loadUserRankCard(); } catch (e) { /* ignore */ }
            return data;
          } else {
            showUserNotLoggedInState();
            return null;
          }
        } else {
          window.currentUserLoggedIn = false;
          window.currentUsername = null;
          window.currentUserRole = null;
          showUserNotLoggedInState();
        }
      } catch (error) {
        console.error('Error loading user info:', error);
        window.currentUserLoggedIn = false;
        window.currentUsername = null;
        window.currentUserRole = null;
        showUserNotLoggedInState();
        return null;
      }
    }
    async function loadUserRankCard() {
      // L·∫•y username t·ª´ getUserInfo.php
      let username = null;
      try {
        const userRes = await fetch('../getUserInfo.php');
        if (userRes.ok) {
          const userData = await userRes.json();
          if (userData.loggedIn) {
            username = userData.username;
          }
        }
      } catch (e) { }

      if (!username) return; // Kh√¥ng ƒëƒÉng nh·∫≠p

      // G·ªçi API l·∫•y rank
      try {
        const res = await fetch(`./getUserRank.php?username=${encodeURIComponent(username)}`);
        if (res.ok) {
          const data = await res.json();
          if (data.error) return;

          // Hi·ªÉn th·ªã rank badge v·ªõi icon cho top 3
          const rankBadgeEl = document.querySelector('.user-rank-card .rank-badge');
          if (data.rank <= 3) {
            // Top 1, 2, 3 - hi·ªÉn th·ªã icon
            const imgPath = `../leaderboard/rank-${data.rank}.png`;
            rankBadgeEl.innerHTML = `<img src="${imgPath}" alt="rank ${data.rank}" class="rank-badge-img rank-badge-top rank-badge-top-${data.rank}">`;
          } else {
            // H·∫°ng kh√°c - hi·ªÉn th·ªã s·ªë
            rankBadgeEl.textContent = `#${data.rank}`;
          }
          
          document.querySelector('.user-rank-card h3').textContent = data.username;
          document.querySelector('.user-rank-card p').textContent = `${data.score} ƒëi·ªÉm`;
          // Ti·∫øn tr√¨nh l√™n h·∫°ng
          let percent = 0;
          if (data.need > 0) {
            percent = Math.min(100, Math.round((data.score / (data.score + data.need)) * 100));
            document.querySelector('.user-rank-card .rank-progress p').textContent =
              `C√≤n ${data.need} ƒëi·ªÉm ƒë·ªÉ l√™n h·∫°ng ${data.rank - 1}`;
          } else {
            percent = 100;
            document.querySelector('.user-rank-card .rank-progress p').textContent = `B·∫°n ƒëang ·ªü h·∫°ng cao nh·∫•t!`;
          }
          document.querySelector('.user-rank-card .progress-fill').style.width = percent + '%';
        }
      } catch (e) { }
    }

    // Th√™m v√†o DOMContentLoaded - ensure we load user info first so highlighting is accurate
    document.addEventListener('DOMContentLoaded', async function () {
      try {
        await loadUserInfo();
      } catch (e) {
        // ignore - loadUserInfo handles its own errors but we still want leaderboard to load
      }
      // now load leaderboard after user state is known
      loadLeaderboard();
    });


    function showUserLoggedInState(userData) {
      const loggedInDiv = document.getElementById('userLoggedIn');
      const notLoggedInDiv = document.getElementById('usernotLoggedIn');

      // Show logged in state, hide not logged in state
      loggedInDiv.style.display = 'flex';
      notLoggedInDiv.style.display = 'none';

      // Update user avatar
      const avatarElement = document.getElementById('userAvatar');
      avatarElement.src = userData.avatarRelative || 'avatar/default.png';

      // Also update the large avatar in the user rank card so it shows the user's avatar
      try {
        const rankAvatar = document.querySelector('.user-rank-card .rank-avatar');
        if (rankAvatar) {
          // Normalize the returned relative path: if it doesn't begin with ../ or /, prepend ../
          const rel = userData.avatarRelative || 'avatar/default.png';
          const resolved = (rel.startsWith('../') || rel.startsWith('/')) ? rel : ('../' + rel);
          rankAvatar.src = resolved;
        }
      } catch (e) { /* ignore if element not present */ }

      // Update user name
      const nameElement = document.getElementById('userName');
      nameElement.textContent = userData.username || 'Guest User';

      // Update user points
      const pointsElement = document.getElementById('userPoints');
      pointsElement.textContent = (userData.score || 0);
    }

    function showUserNotLoggedInState() {
      const loggedInDiv = document.getElementById('userLoggedIn');
      const notLoggedInDiv = document.getElementById('usernotLoggedIn');

      // Show not logged in state, hide logged in state
      loggedInDiv.style.display = 'none';
      notLoggedInDiv.style.display = 'flex';
    }

    function goToLogin() {
      // Redirect to login page
      window.location.href = 'login.php?token=1';
    }

    function navigateToPage(page) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });

      event.target.closest('.nav-item').classList.add('active');

      switch (page) {
        case 'home':
          window.location.href = '/index.php';
          break;
        case 'map':
          window.location.href = '/map.html';
          break;
        case 'checkin':
          window.location.href = '/checkin/checkin.html';
          break;
        case 'leaderboard':
          // Already on leaderboard page
          break;
        case 'profile':
          window.location.href = '/profile/profile.html';
          break;
      }
    }

    // Tab switching
    function switchTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      event.target.classList.add('active');

      // Here you would normally load different data based on the tab
      console.log('Switched to tab:', tab);
    }

    // Load leaderboard t·ª´ DB and render top-10 as a single vertical list
    async function loadLeaderboard() {
      try {
        const response = await fetch('./getLeaderboard.php');
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu');
        const data = await response.json();
        const leaderboardList = document.getElementById('leaderboardList');
        leaderboardList.innerHTML = "";

        // Remove Admin entries and take top 10
        const filtered = data.filter(u => u.Role !== 'Admin').slice(0, 10);

        leaderboardList.innerHTML = renderTop10(filtered);

      } catch (err) {
        document.getElementById('leaderboardList').innerHTML = `<p>L·ªói: ${err.message}</p>`;
      }
    }

    // Render top-10 vertical list. Each row: rank circle, avatar, name + role, right-aligned score
    function renderTop10(list) {
      let html = '<div class="ranking-list">';
      for (let i = 0; i < list.length; i++) {
        const u = list[i];
        const rank = i + 1;
        const username = u.Username || u.username || 'Ng∆∞·ªùi d√πng';
        const role = u.Role || u.role || '';
        const avatar = u.avatar || u.Avatar || 'avatar/default.png';
        // resolve relative avatar paths so they load correctly from /leaderboard/ page.
        // If the API returns paths like 'uploads/avatar/..' (relative to project root),
        // prepend '../' so the src points to the correct location from this file.
        const resolveAvatarPath = (p) => {
          const s = (p || 'avatar/default.png').toString();
          if (s.startsWith('http://') || s.startsWith('https://') || s.startsWith('/') || s.startsWith('../')) return s;
          return '../' + s;
        };
        const resolvedAvatar = resolveAvatarPath(avatar);

  // determine if this is the current logged-in user
  // normalize both sides to avoid mismatches due to case or surrounding spaces
  const normalize = s => (s || '').toString().trim().toLowerCase();
  const isCurrent = !!(window.currentUserLoggedIn && window.currentUsername && normalize(window.currentUsername) === normalize(username));

        // build badge content: top 1-3 use framed images, 4+ show a numeric badge
        let badgeInner = '';
        if (rank <= 3) {
          // image names expected: rank-1.png, rank-2.png, rank-3.png under /leaderboard
          const imgPath = `../leaderboard/rank-${rank}.png`;
          badgeInner = `<img src="${imgPath}" alt="rank ${rank}" class="rank-badge-img rank-badge-top rank-badge-top-${rank}">`;
        } else {
          badgeInner = `<div class="rank-number-only"><b>${rank}</b></div>`;
        }

        html += `
      <div class="ranking-item ${isCurrent ? 'current-user' : ''}" data-username="${encodeURIComponent(username)}">
        <div class="rank-left">
          <div class="rank-badge">${badgeInner}</div>
          <img src="${resolvedAvatar}" alt="${username}" class="rank-avatar">
          <div class="rank-info">
            <h4 class="rank-list-name">${username}</h4>
            <p class="role-text">${role}</p>
          </div>
        </div>
        <div class="rank-right">
          <div class="rank-list-score">${u.Score}</div>
        </div>
      </div>`;
      }
      html += '</div>';
      return html;
    }

// (Initialization handled earlier in the script)
  </script>

    <!-- Lucky Coin Notification -->
    <script src="/lucky_coin/lucky_coin_notification.js"></script>
</body>

</html>