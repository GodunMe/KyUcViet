<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Check-in - Vietnamese Memories</title>
  <link rel="icon" type="image/png" href="logo.PNG" />
  <link rel="stylesheet" href="style.css" />
  
  <!-- Th√™m Leaflet ƒë·ªÉ hi·ªÉn th·ªã b·∫£n ƒë·ªì -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  
  <style>
    /* CSS cho quy tr√¨nh check-in m·ªõi */
    .checkin-steps {
      display: none;
      margin-top: 20px;
    }
    
    .checkin-steps.active {
      display: block;
    }
    
    /* CSS cho danh s√°ch b·∫£o t√†ng g·∫ßn ƒë√¢y */
    .museum-list {
      margin-top: 15px;
    }
    
    .museum-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      padding: 15px;
      margin-bottom: 15px;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .museum-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .museum-card.highlight {
      border: 2px solid #4CAF50;
      background-color: #f1f8e9;
    }
    
    .museum-card h4 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
    }
    
    .museum-address {
      color: #666;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    .museum-distance {
      color: #4CAF50;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .museum-highlight {
      padding: 8px;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
      text-align: center;
      margin-top: 10px;
    }
    
    .museum-remaining {
      margin-top: 10px;
      color: #666;
      font-size: 13px;
    }
    
    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .step-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #ddd;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    
    .step-dot.active {
      background-color: #4CAF50;
      color: white;
    }
    
    .step-dot.completed {
      background-color: #4CAF50;
      color: white;
    }
    
    .step-dot.completed:after {
      content: "‚úì";
    }
    
    .step-line {
      flex: 1;
      height: 2px;
      background-color: #ddd;
      margin: 0 5px;
      align-self: center;
    }
    
    .step-line.active {
      background-color: #4CAF50;
    }
    
    .step-container {
      display: none;
      padding: 20px;
      border-radius: 5px;
      border: 1px solid #ddd;
      margin-bottom: 20px;
    }
    
    .step-container.active {
      display: block;
    }
    
    .location-info {
      margin-bottom: 20px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #ddd;
    }
    
    .location-distance {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .distance-indicator {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      margin-right: 10px;
    }
    
    .distance-ok {
      background-color: #4CAF50;
    }
    
    .distance-far {
      background-color: #f44336;
    }
    
    #locationMap {
      width: 100%;
      height: 200px;
      margin-top: 10px;
      border-radius: 5px;
    }
    
    .photo-upload-container {
      margin-bottom: 20px;
    }
    
    #photoPreview {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      border-radius: 5px;
      margin-top: 10px;
      display: none;
    }
    
    .status-templates {
      margin-top: 10px;
    }
    
    .status-template {
      display: inline-block;
      padding: 5px 10px;
      margin: 5px;
      background-color: #f1f1f1;
      border-radius: 15px;
      cursor: pointer;
    }
    
    .status-template:hover {
      background-color: #e0e0e0;
    }
    
    .checkin-success-message {
      text-align: center;
      padding: 20px;
      background-color: #dff0d8;
      border-radius: 5px;
      margin-top: 20px;
    }
    
    .step-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }
    
    .checkin-error {
      color: #f44336;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- User Header -->
    <div class="user-header">
      <div class="user-info" onclick="toggleUserBox()">
        <img src="avatar/default.png" alt="User" class="user-icon">
        <span class="user-name" id="userName">ƒêang t·∫£i...</span>
      </div>
      <div class="user-box" id="userBox">
        <button onclick="editProfile()">Ch·ªânh s·ª≠a th√¥ng tin</button>
        <button onclick="logout()">Logout</button>
      </div>
    </div>

    <!-- Page Header -->
    <div class="page-header">
      <h1>üìç Check-in</h1>
      <p>Kh√°m ph√° b·∫£o t√†ng g·∫ßn b·∫°n</p>
    </div>

    <!-- Section hi·ªÉn th·ªã ban ƒë·∫ßu -->
    <div id="initialCheckinSection" class="checkin-section">
      <!-- B·∫£o t√†ng g·∫ßn ƒë√¢y -->
      <div class="nearby-museums">
        <h3>B·∫£o t√†ng g·∫ßn b·∫°n</h3>
        <p class="loading-message" id="loadingNearby">ƒêang t√¨m b·∫£o t√†ng g·∫ßn b·∫°n...</p>
        <div id="nearbyList" class="museum-list"></div>
        <p class="checkin-error" id="initialError" style="display:none;"></p>
      </div>
    </div>

    <!-- Quy tr√¨nh Check-in m·ªõi -->
    <div id="checkinSteps" class="checkin-steps">
      <!-- B∆∞·ªõc ƒëi -->
      <div class="step-indicator">
        <div class="step-dot active" id="step1Dot">1</div>
        <div class="step-line" id="line1"></div>
        <div class="step-dot" id="step2Dot">2</div>
        <div class="step-line" id="line2"></div>
        <div class="step-dot" id="step3Dot">3</div>
        <div class="step-line" id="line3"></div>
        <div class="step-dot" id="step4Dot">4</div>
      </div>
      
      <!-- B∆∞·ªõc 1: X√°c nh·∫≠n b·∫£o t√†ng -->
      <div id="step1Container" class="step-container active">
        <h3>X√°c nh·∫≠n th√¥ng tin b·∫£o t√†ng</h3>
        <div id="museumInfo">
          <p><strong>T√™n b·∫£o t√†ng:</strong> <span id="museumName">...</span></p>
          <p><strong>ƒê·ªãa ch·ªâ:</strong> <span id="museumAddress">...</span></p>
        </div>
        <div class="step-navigation">
          <button onclick="cancelCheckin()">H·ªßy</button>
          <button onclick="goToStep2()">Ti·∫øp t·ª•c</button>
        </div>
      </div>
      
      <!-- B∆∞·ªõc 2: X√°c minh v·ªã tr√≠ -->
      <div id="step2Container" class="step-container">
        <h3>X√°c minh v·ªã tr√≠</h3>
        <p>ƒêang l·∫•y v·ªã tr√≠ c·ªßa b·∫°n...</p>
        <div class="location-info" id="locationInfo" style="display:none;">
          <div class="location-distance">
            <div class="distance-indicator" id="distanceIndicator"></div>
            <span id="distanceText"></span>
          </div>
          <div id="locationMap"></div>
        </div>
        <p class="checkin-error" id="locationError" style="display:none;"></p>
        <div class="step-navigation">
          <button onclick="goToStep1()">Quay l·∫°i</button>
          <button onclick="goToStep3()" id="continueToStep3" disabled>Ti·∫øp t·ª•c</button>
        </div>
      </div>
      
      <!-- B∆∞·ªõc 3: Ch·ª•p ·∫£nh -->
      <div id="step3Container" class="step-container">
        <h3>Ch·ª•p ·∫£nh check-in</h3>
        <div class="photo-upload-container">
          <input type="file" id="photoInput" accept="image/*" capture="camera" style="display:none;">
          <button onclick="document.getElementById('photoInput').click()">
            üì∏ Ch·ª•p ·∫£nh ho·∫∑c ch·ªçn t·ª´ th∆∞ vi·ªán
          </button>
          <img id="photoPreview" src="#" alt="Xem tr∆∞·ªõc ·∫£nh check-in">
        </div>
        <p class="checkin-error" id="photoError" style="display:none;"></p>
        <div class="step-navigation">
          <button onclick="goToStep2()">Quay l·∫°i</button>
          <button onclick="goToStep4()" id="continueToStep4" disabled>Ti·∫øp t·ª•c</button>
        </div>
      </div>
      
      <!-- B∆∞·ªõc 4: Th√™m tr·∫°ng th√°i -->
      <div id="step4Container" class="step-container">
        <h3>Th√™m tr·∫°ng th√°i check-in</h3>
        <textarea id="statusText" rows="3" placeholder="Chia s·∫ª c·∫£m nghƒ© c·ªßa b·∫°n v·ªÅ b·∫£o t√†ng n√†y..."></textarea>
        <div class="status-templates" id="statusTemplates">
          <div class="status-template" onclick="selectStatusTemplate(this)">ƒêang tham quan b·∫£o t√†ng</div>
          <div class="status-template" onclick="selectStatusTemplate(this)">H·ªçc h·ªèi ƒë∆∞·ª£c nhi·ªÅu ƒëi·ªÅu th√∫ v·ªã!</div>
          <div class="status-template" onclick="selectStatusTemplate(this)">Tr·∫£i nghi·ªám tuy·ªát v·ªùi t·∫°i ƒë√¢y!</div>
        </div>
        
        <h4>Quy·ªÅn ri√™ng t∆∞</h4>
        <select id="privacyOption">
          <option value="public">C√¥ng khai</option>
          <option value="friends">Ch·ªâ b·∫°n b√®</option>
          <option value="private">Ri√™ng t∆∞</option>
        </select>
        
        <p class="checkin-error" id="finalError" style="display:none;"></p>
        
        <div class="step-navigation">
          <button onclick="goToStep3()">Quay l·∫°i</button>
          <button onclick="submitFinalCheckin()">Ho√†n t·∫•t Check-in</button>
        </div>
      </div>
      
      <!-- Th√¥ng b√°o th√†nh c√¥ng -->
      <div id="checkinSuccessMessage" class="checkin-success-message" style="display:none;">
        <h3>üéâ Check-in th√†nh c√¥ng!</h3>
        <p id="successPoints"></p>
        <button onclick="finishCheckin()">Xem danh s√°ch check-in</button>
      </div>
    </div>

    <!-- Recent Check-ins -->
    <div class="recent-checkins">
      <h3>Check-in g·∫ßn ƒë√¢y</h3>
      <div id="recentList" class="checkin-history">
        <p id="loadingCheckins">ƒêang t·∫£i...</p>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item" onclick="navigateToPage('home')">
      <div class="nav-icon">üè†</div>
      <div class="nav-label">Home</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('map')">
      <div class="nav-icon">üó∫Ô∏è</div>
      <div class="nav-label">Map</div>
    </div>
    <div class="nav-item active" onclick="navigateToPage('checkin')">
      <div class="nav-icon">üìç</div>
      <div class="nav-label">Check-in</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('leaderboard')">
      <div class="nav-icon">üèÜ</div>
      <div class="nav-label">B·∫£ng x·∫øp h·∫°ng</div>
    </div>
    <div class="nav-item" onclick="navigateToPage('profile')">
      <div class="nav-icon">üë§</div>
      <div class="nav-label">Profile</div>
    </div>
  </div>

  <script>
    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ l∆∞u d·ªØ li·ªáu gi·ªØa c√°c b∆∞·ªõc
    let currentCheckinData = {
      museumId: null,
      userLat: null,
      userLng: null,
      photoFile: null,
      photoPath: null,
      status: "",
      privacy: "public"
    };
    
    // Navigation functions
    function toggleUserBox() {
      const box = document.getElementById('userBox');
      box.classList.toggle('active');
    }

    function editProfile() {
      window.location.href = '/editProfile.html';
    }

    function logout() {
      window.location.href = '/logout.php';
    }

    function navigateToPage(page) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      if (event && event.target) {
        const navItem = event.target.closest('.nav-item');
        if (navItem) navItem.classList.add('active');
      }
      
      switch(page) {
        case 'home':
          window.location.href = '/index.php';
          break;
        case 'map':
          window.location.href = '/map.html';
          break;
        case 'checkin':
          // Already on checkin page
          break;
        case 'leaderboard':
          window.location.href = '/leaderboard.html';
          break;
        case 'profile':
          window.location.href = '/profile.html';
          break;
      }
    }

    // H√†m ƒë·ªÉ l·∫•y v·ªã tr√≠ ng∆∞·ªùi d√πng v√† t√¨m b·∫£o t√†ng g·∫ßn ƒë√≥
    async function findNearbyMuseums() {
      try {
        document.getElementById('loadingNearby').style.display = 'block';
        document.getElementById('nearbyList').innerHTML = '';
        document.getElementById('initialError').style.display = 'none';
        
        console.log('B·∫Øt ƒë·∫ßu t√¨m b·∫£o t√†ng g·∫ßn ƒë√¢y...');
        
        // Ki·ªÉm tra n·∫øu tr√¨nh duy·ªát h·ªó tr·ª£ v·ªã tr√≠
        if (!navigator.geolocation) {
          throw new Error('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã');
        }
        
        // S·ª≠ d·ª•ng promise ƒë·ªÉ x·ª≠ l√Ω l·∫•y v·ªã tr√≠ v·ªõi c√°c t√πy ch·ªçn ch√≠nh x√°c cao
        console.log('ƒêang l·∫•y v·ªã tr√≠ hi·ªán t·∫°i...');
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 15000, // TƒÉng th·ªùi gian ch·ªù l√™n 15 gi√¢y
            maximumAge: 0
          });
        });
        
        const userLat = position.coords.latitude;
        const userLng = position.coords.longitude;
        console.log(`ƒê√£ l·∫•y v·ªã tr√≠: ${userLat}, ${userLng}`);
        
        // G·ªçi API ƒë·ªÉ l·∫•y danh s√°ch b·∫£o t√†ng g·∫ßn ƒë√≥
        console.log('ƒêang g·ª≠i y√™u c·∫ßu ƒë·∫øn server...');
        const response = await fetch('getNearbyMuseums.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `latitude=${userLat}&longitude=${userLng}`
        });
        
        if (!response.ok) {
          throw new Error('L·ªói khi k·∫øt n·ªëi v·ªõi m√°y ch·ªß');
        }
        
        const data = await response.json();
        console.log('Ph·∫£n h·ªìi t·ª´ server:', data);
        
        if (!data.success) {
          throw new Error(data.error || 'Kh√¥ng th·ªÉ t√¨m b·∫£o t√†ng g·∫ßn b·∫°n');
        }
        
        // Hi·ªÉn th·ªã danh s√°ch b·∫£o t√†ng
        displayNearbyMuseums(data.museums);
        
      } catch (error) {
        console.error('L·ªói khi t√¨m b·∫£o t√†ng:', error);
        document.getElementById('loadingNearby').style.display = 'none';
        showError('initialError', 'Kh√¥ng th·ªÉ t√¨m b·∫£o t√†ng g·∫ßn b·∫°n: ' + error.message);
      }
    }
    
    // Hi·ªÉn th·ªã danh s√°ch b·∫£o t√†ng g·∫ßn ƒë√≥
    function displayNearbyMuseums(museums) {
      const container = document.getElementById('nearbyList');
      document.getElementById('loadingNearby').style.display = 'none';
      
      if (museums.length === 0) {
        container.innerHTML = '<p>Kh√¥ng t√¨m th·∫•y b·∫£o t√†ng n√†o g·∫ßn b·∫°n</p>';
        return;
      }
      
      container.innerHTML = '';
      
      // Hi·ªÉn th·ªã 3 b·∫£o t√†ng g·∫ßn nh·∫•t
      museums.forEach((museum, index) => {
        const card = document.createElement('div');
        card.className = 'museum-card' + (index === 0 ? ' highlight' : '');
        card.onclick = () => selectMuseum(museum);
        
        // Format kho·∫£ng c√°ch
        let distanceText = '';
        if (museum.distance < 1000) {
          distanceText = `${museum.distance} m√©t`;
        } else {
          distanceText = `${(museum.distance / 1000).toFixed(1)} km`;
        }
        
        // T·∫°o n·ªôi dung card
        let cardContent = `
          <h4>${museum.name}</h4>
          <div class="museum-address">${museum.address}</div>
          <div class="museum-distance">C√°ch b·∫°n ${distanceText}</div>
        `;
        
        // N·∫øu l√† b·∫£o t√†ng g·∫ßn nh·∫•t, th√™m th√¥ng b√°o n·ªïi b·∫≠t
        if (index === 0) {
          cardContent += `<div class="museum-highlight">B·∫°n ƒëang g·∫ßn nh·∫•t v·ªõi b·∫£o t√†ng n√†y! H√£y t·ªõi ƒë·ªÉ check-in</div>`;
        }
        
        // Hi·ªÉn th·ªã th√¥ng tin check-in c√≤n l·∫°i
        if (museum.remainingCheckins <= 0) {
          cardContent += `<div class="museum-remaining">B·∫°n ƒë√£ check-in t·∫°i b·∫£o t√†ng n√†y h√¥m nay</div>`;
        } else if (museum.waitTime > 0) {
          const waitMinutes = Math.ceil(museum.waitTime / 60);
          cardContent += `<div class="museum-remaining">ƒê·ª£i ${waitMinutes} ph√∫t n·ªØa ƒë·ªÉ check-in l·∫°i</div>`;
        } else {
          cardContent += `<div class="museum-remaining">B·∫°n c√≥ th·ªÉ check-in ngay b√¢y gi·ªù</div>`;
        }
        
        card.innerHTML = cardContent;
        container.appendChild(card);
      });
    }
    
    // Ch·ªçn b·∫£o t√†ng ƒë·ªÉ check-in
    async function selectMuseum(museum) {
      try {
        // L∆∞u ID b·∫£o t√†ng v√†o d·ªØ li·ªáu check-in
        currentCheckinData.museumId = museum.id;
        currentCheckinData.userLat = museum.userLat;
        currentCheckinData.userLng = museum.userLng;
        
        // Hi·ªÉn th·ªã th√¥ng tin b·∫£o t√†ng
        document.getElementById('museumName').textContent = museum.name;
        document.getElementById('museumAddress').textContent = museum.address;
        
        // Ki·ªÉm tra t∆∞ c√°ch check-in
        await checkEligibility(museum.id);
        
        // Chuy·ªÉn th·∫≥ng sang b∆∞·ªõc ch·ª•p ·∫£nh (b∆∞·ªõc 3)
        showCheckinSteps();
        goToStep3();
        
      } catch (error) {
        alert('L·ªói: ' + error.message);
      }
    }
    
    // Ch·ª©c nƒÉng nh·∫≠p m√£ check-in ƒë√£ ƒë∆∞·ª£c lo·∫°i b·ªè
    
    // Ki·ªÉm tra ng∆∞·ªùi d√πng c√≥ ƒë·ªß ƒëi·ªÅu ki·ªán check-in kh√¥ng
    async function checkEligibility(museumId) {
      try {
        const response = await fetch('checkCheckinEligibility.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `museumId=${encodeURIComponent(museumId)}`
        });
        
        if (!response.ok) {
          throw new Error('L·ªói khi ki·ªÉm tra t∆∞ c√°ch check-in');
        }
        
        const data = await response.json();
        
        if (!data.success || !data.canCheckin) {
          throw new Error(data.reason || 'B·∫°n kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán ƒë·ªÉ check-in');
        }
        
        return true;
      } catch (error) {
        showError('initialError', error.message);
        throw error;
      }
    }
    
    // Hi·ªÉn th·ªã quy tr√¨nh check-in
    function showCheckinSteps() {
      document.getElementById('initialCheckinSection').style.display = 'none';
      document.getElementById('checkinSteps').classList.add('active');
    }
    
    // H·ªßy quy tr√¨nh check-in v√† quay l·∫°i m√†n h√¨nh ban ƒë·∫ßu
    function cancelCheckin() {
      document.getElementById('initialCheckinSection').style.display = 'block';
      document.getElementById('checkinSteps').classList.remove('active');
      document.getElementById('initialError').style.display = 'none';
      resetSteps();
    }
    
    // Reset t·∫•t c·∫£ c√°c b∆∞·ªõc v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
    function resetSteps() {
      // ·∫®n t·∫•t c·∫£ c√°c container
      document.querySelectorAll('.step-container').forEach(container => {
        container.classList.remove('active');
      });
      
      // Reset c√°c indicator
      document.querySelectorAll('.step-dot').forEach(dot => {
        dot.classList.remove('active', 'completed');
      });
      document.querySelectorAll('.step-line').forEach(line => {
        line.classList.remove('active');
      });
      
      // Hi·ªÉn th·ªã b∆∞·ªõc 1
      document.getElementById('step1Container').classList.add('active');
      document.getElementById('step1Dot').classList.add('active');
      
      // Reset c√°c tr∆∞·ªùng
      document.getElementById('photoPreview').style.display = 'none';
      document.getElementById('photoInput').value = '';
      document.getElementById('statusText').value = '';
      document.getElementById('privacyOption').value = 'public';
      
      // Reset l·ªói
      document.querySelectorAll('.checkin-error').forEach(error => {
        error.style.display = 'none';
      });
      
      // Reset data
      currentCheckinData = {
        museumId: currentCheckinData.museumId,
        userLat: null,
        userLng: null,
        photoFile: null,
        photoPath: null,
        status: "",
        privacy: "public"
      };
      
      // Reset c√°c n√∫t
      document.getElementById('continueToStep3').disabled = true;
      document.getElementById('continueToStep4').disabled = true;
    }

    // CHUY·ªÇN B∆Ø·ªöC
    
    function goToStep1() {
      switchToStep(1);
    }
    
    async function goToStep2() {
      // ƒê√°nh d·∫•u b∆∞·ªõc 1 ho√†n th√†nh
      document.getElementById('step1Dot').classList.remove('active');
      document.getElementById('step1Dot').classList.add('completed');
      document.getElementById('line1').classList.add('active');
      
      // Hi·ªÉn th·ªã b∆∞·ªõc 2
      switchToStep(2);
      
      // L·∫•y v·ªã tr√≠ ng∆∞·ªùi d√πng
      await getUserLocation();
    }
    
    function goToStep3() {
      // ƒê√°nh d·∫•u b∆∞·ªõc 2 ho√†n th√†nh
      document.getElementById('step2Dot').classList.remove('active');
      document.getElementById('step2Dot').classList.add('completed');
      document.getElementById('line2').classList.add('active');
      
      // Hi·ªÉn th·ªã b∆∞·ªõc 3
      switchToStep(3);
    }
    
    function goToStep4() {
      // ƒê√°nh d·∫•u b∆∞·ªõc 3 ho√†n th√†nh
      document.getElementById('step3Dot').classList.remove('active');
      document.getElementById('step3Dot').classList.add('completed');
      document.getElementById('line3').classList.add('active');
      
      // Hi·ªÉn th·ªã b∆∞·ªõc 4
      switchToStep(4);
      
      // T·∫°o c√°c m·∫´u tr·∫°ng th√°i d·ª±a v√†o t√™n b·∫£o t√†ng
      generateStatusTemplates();
    }
    
    function switchToStep(step) {
      // ·∫®n t·∫•t c·∫£ c√°c b∆∞·ªõc
      document.querySelectorAll('.step-container').forEach(container => {
        container.classList.remove('active');
      });
      
      // ƒê√°nh d·∫•u t·∫•t c·∫£ c√°c ch·∫•m tr∆∞·ªõc b∆∞·ªõc n√†y th√†nh completed
      for (let i = 1; i < step; i++) {
        document.getElementById(`step${i}Dot`).classList.remove('active');
        document.getElementById(`step${i}Dot`).classList.add('completed');
        if (i < 4) document.getElementById(`line${i}`).classList.add('active');
      }
      
      // K√≠ch ho·∫°t b∆∞·ªõc hi·ªán t·∫°i
      document.getElementById(`step${step}Container`).classList.add('active');
      document.getElementById(`step${step}Dot`).classList.add('active');
      document.getElementById(`step${step}Dot`).classList.remove('completed');
      
      // Reset c√°c b∆∞·ªõc sau
      for (let i = step + 1; i <= 4; i++) {
        document.getElementById(`step${i}Dot`).classList.remove('active', 'completed');
        if (i <= 3) document.getElementById(`line${i-1}`).classList.remove('active');
      }
    }
    
    // X·ª¨ L√ù V·ªä TR√ç (B∆Ø·ªöC 2)
    
    async function getUserLocation() {
      try {
        // Hi·ªÉn th·ªã ƒëang t·∫£i
        document.getElementById('locationInfo').style.display = 'none';
        document.getElementById('locationError').style.display = 'none';
        document.getElementById('continueToStep3').disabled = true;
        
        // L·∫•y v·ªã tr√≠
        if (!navigator.geolocation) {
          throw new Error('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã');
        }
        
        // S·ª≠ d·ª•ng promise ƒë·ªÉ x·ª≠ l√Ω l·∫•y v·ªã tr√≠
        const position = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(resolve, reject, {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0
          });
        });
        
        // L∆∞u v·ªã tr√≠ ng∆∞·ªùi d√πng
        currentCheckinData.userLat = position.coords.latitude;
        currentCheckinData.userLng = position.coords.longitude;
        
        // Ki·ªÉm tra v·ªã tr√≠ so v·ªõi b·∫£o t√†ng
        await verifyLocation();
        
      } catch (error) {
        let errorMessage = 'Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n';
        
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = 'B·∫°n ƒë√£ t·ª´ ch·ªëi quy·ªÅn truy c·∫≠p v·ªã tr√≠';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMessage = 'Th√¥ng tin v·ªã tr√≠ kh√¥ng c√≥ s·∫µn';
            break;
          case error.TIMEOUT:
            errorMessage = 'ƒê√£ h·∫øt th·ªùi gian y√™u c·∫ßu v·ªã tr√≠';
            break;
        }
        
        showError('locationError', errorMessage);
      }
    }
    
    async function verifyLocation() {
      try {
        // G·ªçi API ki·ªÉm tra v·ªã tr√≠
        const response = await fetch('verifyLocation.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `museumId=${encodeURIComponent(currentCheckinData.museumId)}&userLat=${encodeURIComponent(currentCheckinData.userLat)}&userLng=${encodeURIComponent(currentCheckinData.userLng)}`
        });
        
        if (!response.ok) {
          throw new Error('L·ªói khi ki·ªÉm tra v·ªã tr√≠');
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Kh√¥ng th·ªÉ x√°c minh v·ªã tr√≠');
        }
        
        // Hi·ªÉn th·ªã k·∫øt qu·∫£
        document.getElementById('locationInfo').style.display = 'block';
        document.getElementById('distanceIndicator').className = 'distance-indicator ' + (data.withinRange ? 'distance-ok' : 'distance-far');
        document.getElementById('distanceText').textContent = `B·∫°n ƒëang c√°ch b·∫£o t√†ng ${data.distance}m (t·ªëi ƒëa ${data.maxAllowedDistance}m)`;
        
        // T·∫°o b·∫£n ƒë·ªì
        createMap(data.museumDetails.latitude, data.museumDetails.longitude, currentCheckinData.userLat, currentCheckinData.userLng);
        
        // Ch·ªâ cho ph√©p ti·∫øp t·ª•c n·∫øu ng∆∞·ªùi d√πng ƒëang ·ªü trong ph·∫°m vi
        document.getElementById('continueToStep3').disabled = !data.withinRange;
        
        if (!data.withinRange) {
          showError('locationError', `B·∫°n ƒëang ·ªü qu√° xa b·∫£o t√†ng (${data.distance}m). Vui l√≤ng ƒë·∫øn g·∫ßn h∆°n ƒë·ªÉ check-in (t·ªëi ƒëa ${data.maxAllowedDistance}m).`);
        } else {
          document.getElementById('locationError').style.display = 'none';
        }
        
      } catch (error) {
        showError('locationError', error.message);
      }
    }
    
    function createMap(museumLat, museumLng, userLat, userLng) {
      // T·∫°o b·∫£n ƒë·ªì
      const map = L.map('locationMap').setView([museumLat, museumLng], 16);
      
      // Th√™m layer b·∫£n ƒë·ªì
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Th√™m marker b·∫£o t√†ng
      L.marker([museumLat, museumLng])
        .addTo(map)
        .bindPopup('V·ªã tr√≠ b·∫£o t√†ng')
        .openPopup();
      
      // Th√™m marker ng∆∞·ªùi d√πng
      L.marker([userLat, userLng])
        .addTo(map)
        .bindPopup('V·ªã tr√≠ c·ªßa b·∫°n');
      
      // V·∫Ω ƒë∆∞·ªùng th·∫≥ng gi·ªØa 2 ƒëi·ªÉm
      L.polyline([[museumLat, museumLng], [userLat, userLng]], {color: 'blue'}).addTo(map);
      
      // ƒêi·ªÅu ch·ªânh view ƒë·ªÉ hi·ªÉn th·ªã c·∫£ 2 ƒëi·ªÉm
      const bounds = L.latLngBounds([
        [museumLat, museumLng],
        [userLat, userLng]
      ]);
      map.fitBounds(bounds.pad(0.1));
    }
    
    // X·ª¨ L√ù ·∫¢NH (B∆Ø·ªöC 3)
    
    // X·ª≠ l√Ω ch·ªçn ·∫£nh
    document.addEventListener('DOMContentLoaded', function() {
      const photoInput = document.getElementById('photoInput');
      const photoPreview = document.getElementById('photoPreview');
      
      photoInput.addEventListener('change', async function(e) {
        if (e.target.files.length === 0) {
          return;
        }
        
        const file = e.target.files[0];
        
        // Ki·ªÉm tra file c√≥ ph·∫£i l√† ·∫£nh kh√¥ng
        if (!file.type.match('image.*')) {
          showError('photoError', 'Vui l√≤ng ch·ªçn m·ªôt file ·∫£nh');
          return;
        }
        
        // Hi·ªÉn th·ªã xem tr∆∞·ªõc
        photoPreview.src = URL.createObjectURL(file);
        photoPreview.style.display = 'block';
        
        // L∆∞u file ·∫£nh
        currentCheckinData.photoFile = file;
        
        // Cho ph√©p ti·∫øp t·ª•c
        document.getElementById('continueToStep4').disabled = false;
        document.getElementById('photoError').style.display = 'none';
      });
    });
    
    // X·ª¨ L√ù TR·∫†NG TH√ÅI (B∆Ø·ªöC 4)
    
    // T·∫°o c√°c m·∫´u tr·∫°ng th√°i d·ª±a v√†o t√™n b·∫£o t√†ng
    function generateStatusTemplates() {
      const museumName = document.getElementById('museumName').textContent;
      const templatesContainer = document.getElementById('statusTemplates');
      
      templatesContainer.innerHTML = '';
      
      const templates = [
        `ƒêang kh√°m ph√° ${museumName}`,
        `H·ªçc h·ªèi ƒë∆∞·ª£c nhi·ªÅu ƒëi·ªÅu th√∫ v·ªã t·∫°i ${museumName}`,
        `·∫§n t∆∞·ª£ng v·ªõi c√°c hi·ªán v·∫≠t t·∫°i ${museumName}`,
        `M·ªôt ng√†y tuy·ªát v·ªùi t·∫°i ${museumName}`
      ];
      
      templates.forEach(template => {
        const div = document.createElement('div');
        div.className = 'status-template';
        div.textContent = template;
        div.onclick = function() { selectStatusTemplate(this); };
        templatesContainer.appendChild(div);
      });
    }
    
    // Ch·ªçn m·∫´u tr·∫°ng th√°i
    function selectStatusTemplate(element) {
      document.getElementById('statusText').value = element.textContent;
    }
    
    // X·ª¨ L√ù HO√ÄN T·∫§T CHECK-IN
    
    async function submitFinalCheckin() {
      try {
        document.getElementById('finalError').style.display = 'none';
        
        // L·∫•y c√°c gi√° tr·ªã cu·ªëi c√πng
        const status = document.getElementById('statusText').value.trim() || `ƒê√£ check-in t·∫°i ${document.getElementById('museumName').textContent}`;
        const privacy = document.getElementById('privacyOption').value;
        
        currentCheckinData.status = status;
        currentCheckinData.privacy = privacy;
        
        // T·∫£i ·∫£nh l√™n tr∆∞·ªõc
        await uploadPhoto();
        
        // G·ª≠i th√¥ng tin check-in
        const response = await fetch('createCheckinPost.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: `museumId=${encodeURIComponent(currentCheckinData.museumId)}&latitude=${encodeURIComponent(currentCheckinData.userLat)}&longitude=${encodeURIComponent(currentCheckinData.userLng)}&status=${encodeURIComponent(currentCheckinData.status)}&photoPath=${encodeURIComponent(currentCheckinData.photoPath)}&privacy=${encodeURIComponent(currentCheckinData.privacy)}`
        });
        
        if (!response.ok) {
          throw new Error('L·ªói khi t·∫°o b√†i ƒëƒÉng check-in');
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Kh√¥ng th·ªÉ ho√†n t·∫•t check-in');
        }
        
        // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
        document.getElementById('successPoints').textContent = data.message;
        
        // ·∫®n c√°c b∆∞·ªõc check-in v√† hi·ªán th√¥ng b√°o th√†nh c√¥ng
        document.querySelectorAll('.step-container').forEach(container => {
          container.style.display = 'none';
        });
        document.querySelector('.step-indicator').style.display = 'none';
        document.getElementById('checkinSuccessMessage').style.display = 'block';
        
        // C·∫≠p nh·∫≠t danh s√°ch check-in g·∫ßn ƒë√¢y
        loadRecentCheckins();
        
      } catch (error) {
        showError('finalError', error.message);
      }
    }
    
    async function uploadPhoto() {
      if (!currentCheckinData.photoFile) {
        throw new Error('Ch∆∞a ch·ªçn ·∫£nh check-in');
      }
      
      // T·∫°o form data ƒë·ªÉ t·∫£i ·∫£nh l√™n
      const formData = new FormData();
      formData.append('photo', currentCheckinData.photoFile);
      
      try {
        const response = await fetch('uploadPhoto.php', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('L·ªói khi t·∫£i ·∫£nh l√™n');
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Kh√¥ng th·ªÉ t·∫£i ·∫£nh l√™n');
        }
        
        // L∆∞u ƒë∆∞·ªùng d·∫´n ·∫£nh
        currentCheckinData.photoPath = data.photoPath;
        return data.photoPath;
        
      } catch (error) {
        throw new Error('L·ªói khi t·∫£i ·∫£nh: ' + error.message);
      }
    }
    
    function finishCheckin() {
      // Quay v·ªÅ m√†n h√¨nh ban ƒë·∫ßu
      document.getElementById('initialCheckinSection').style.display = 'block';
      document.getElementById('checkinSteps').classList.remove('active');
      document.getElementById('checkinSuccessMessage').style.display = 'none';
      document.querySelector('.step-indicator').style.display = 'flex';
      
      // Reset quy tr√¨nh check-in
      resetSteps();
      
      // X√≥a d·ªØ li·ªáu
      document.getElementById('checkinCode').value = '';
    }
    
    // LOAD D·ªÆ LI·ªÜU V√Ä KH·ªûI T·∫†O
    
    // T·∫£i danh s√°ch check-in g·∫ßn ƒë√¢y
    async function loadRecentCheckins() {
      try {
        document.getElementById('loadingCheckins').textContent = 'ƒêang t·∫£i...';
        
        const response = await fetch('getRecentCheckins.php');
        
        if (!response.ok) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch check-in');
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'L·ªói khi t·∫£i danh s√°ch check-in');
        }
        
        // Hi·ªÉn th·ªã danh s√°ch check-in
        const recentList = document.getElementById('recentList');
        recentList.innerHTML = '';
        
        if (data.checkins.length === 0) {
          recentList.innerHTML = '<p>B·∫°n ch∆∞a c√≥ check-in n√†o</p>';
          return;
        }
        
        data.checkins.forEach(checkin => {
          const checkinItem = document.createElement('div');
          checkinItem.className = 'checkin-item';
          
          checkinItem.innerHTML = `
            <div class="checkin-info">
              <h4>${checkin.museumName}</h4>
              <p class="checkin-time">${checkin.friendlyTime}</p>
              <p class="checkin-points">+${checkin.points} ƒëi·ªÉm</p>
            </div>
            <div class="checkin-status">‚úì</div>
          `;
          
          recentList.appendChild(checkinItem);
        });
        
      } catch (error) {
        document.getElementById('loadingCheckins').textContent = 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch check-in: ' + error.message;
      }
    }
    
    // L·∫•y th√¥ng tin ng∆∞·ªùi d√πng ƒëang ƒëƒÉng nh·∫≠p
    async function loadUserInfo() {
      try {
        const response = await fetch('getUserInfo.php');
        
        if (!response.ok) {
          throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ng∆∞·ªùi d√πng');
        }
        
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng');
        }
        
        // Hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng
        document.getElementById('userName').textContent = data.name;
        
      } catch (error) {
        console.error('L·ªói khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng:', error);
      }
    }
    
    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói
    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }
    
    // Kh√¥ng c·∫ßn h√†m kh·ªüi t·∫°o QR Scanner v√¨ kh√¥ng d√πng ch·ª©c nƒÉng n√†y

    // Th·ª≠ t√¨m b·∫£o t√†ng g·∫ßn ƒë√≥ v·ªõi s·ªë l·∫ßn th·ª≠ t·ªëi ƒëa
    let locationAttempts = 0;
    const maxLocationAttempts = 3;
    
    function attemptToFindMuseums() {
      if (locationAttempts < maxLocationAttempts) {
        locationAttempts++;
        console.log(`ƒêang th·ª≠ l·∫•y v·ªã tr√≠ l·∫ßn th·ª© ${locationAttempts}/${maxLocationAttempts}...`);
        findNearbyMuseums().catch(error => {
          console.error(`L·∫ßn th·ª≠ ${locationAttempts} th·∫•t b·∫°i:`, error);
          if (locationAttempts < maxLocationAttempts) {
            // Th·ª≠ l·∫°i sau 3 gi√¢y
            setTimeout(attemptToFindMuseums, 3000);
          }
        });
      } else {
        document.getElementById('loadingNearby').textContent = 
          'Kh√¥ng th·ªÉ t√¨m th·∫•y v·ªã tr√≠ c·ªßa b·∫°n sau nhi·ªÅu l·∫ßn th·ª≠. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p v·ªã tr√≠ v√† l√†m m·ªõi trang.';
      }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
      // T·∫£i th√¥ng tin ng∆∞·ªùi d√πng
      loadUserInfo();
      
      // T·∫£i danh s√°ch check-in g·∫ßn ƒë√¢y
      loadRecentCheckins();
      
      // B·∫Øt ƒë·∫ßu t√¨m b·∫£o t√†ng g·∫ßn ƒë√≥
      attemptToFindMuseums();
      
      // Th√™m n√∫t l√†m m·ªõi v·ªã tr√≠
      const nearbyTitle = document.querySelector('.nearby-museums h3');
      if (nearbyTitle) {
        const refreshButton = document.createElement('button');
        refreshButton.textContent = 'üîÑ L√†m m·ªõi';
        refreshButton.style.marginLeft = '10px';
        refreshButton.style.fontSize = '14px';
        refreshButton.style.padding = '4px 8px';
        refreshButton.onclick = function() {
          locationAttempts = 0;
          attemptToFindMuseums();
        };
        nearbyTitle.appendChild(refreshButton);
      }
    });
  </script>
</body>
</html>