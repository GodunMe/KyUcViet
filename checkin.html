<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Check-in - Vietnamese Memories</title>
    <link rel="icon" type="image/png" href="logo.PNG">
    <link rel="stylesheet" href="style.css">
    
    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        /* Check-in Styles */
        .checkin-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .page-header h1 {
            margin: 0;
            font-size: 28px;
            font-weight: bold;
        }

        .page-header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
            font-size: 16px;
        }

        /* Step Indicator */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0;
            position: relative;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #666;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .step-circle.active {
            background-color: #4CAF50;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        .step-circle.completed {
            background-color: #4CAF50;
            color: white;
        }

        .step-circle.completed::after {
            content: "‚úì";
            font-size: 18px;
        }

        .step-label {
            margin-top: 8px;
            font-size: 12px;
            text-align: center;
            color: #666;
            max-width: 80px;
        }

        .step-line {
            position: absolute;
            top: 20px;
            left: 50px;
            right: 50px;
            height: 3px;
            background-color: #e0e0e0;
            z-index: 1;
            transition: background-color 0.3s ease;
        }

        .step-line.active {
            background-color: #4CAF50;
        }

        /* Step Content */
        .step-content {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: 1px solid #f0f0f0;
        }

        .step-content.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .step-title {
            color: #2E7D32;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: bold;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .step-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* Museum Selection */
        .nearby-museums {
            max-height: 400px;
            overflow-y: auto;
        }

        .museum-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .museum-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
            border-color: #4CAF50;
        }

        .museum-card.selected {
            border-color: #4CAF50;
            background-color: #f8fff8;
        }

        .museum-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .museum-address {
            color: #666;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .museum-address::before {
            content: "üìç";
            margin-right: 8px;
        }

        .museum-distance {
            color: #4CAF50;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
        }

        .museum-distance::before {
            content: "üìè";
            margin-right: 8px;
        }

        .museum-checkin-info {
            background-color: #f0f8f0;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 13px;
            color: #2E7D32;
        }

        /* Location Verification */
        .location-status {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .location-loading {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
        }

        .location-success {
            background-color: #e8f5e8;
            border: 1px solid #4caf50;
        }

        .location-error {
            background-color: #ffebee;
            border: 1px solid #f44336;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            margin: 20px 0;
        }

        .distance-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .distance-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        .distance-status {
            color: #666;
            font-size: 14px;
        }

        /* Photo Upload */
        .photo-upload-section {
            text-align: center;
            margin: 20px 0;
        }

        .photo-upload-btn {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            margin: 10px;
        }

        .photo-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            font-size: 12px;
        }

        .photo-count {
            text-align: center;
            color: #666;
            margin-top: 10px;
            font-size: 14px;
        }

        /* Status Input */
        .status-input-section {
            margin: 20px 0;
        }

        .status-textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .status-textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .status-templates {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .status-template {
            background-color: #f0f8f0;
            border: 1px solid #4CAF50;
            color: #2E7D32;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }

        .status-template:hover {
            background-color: #4CAF50;
            color: white;
            transform: translateY(-1px);
        }

        .privacy-section {
            margin-top: 20px;
        }

        .privacy-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            background-color: white;
        }

        .privacy-select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        /* Navigation Buttons */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .nav-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .nav-btn.secondary {
            background-color: #f5f5f5;
            color: #666;
        }

        .nav-btn.secondary:hover {
            background-color: #e0e0e0;
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .nav-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .nav-btn:disabled {
            background-color: #cccccc !important;
            color: #666 !important;
            cursor: not-allowed !important;
            transform: none !important;
            box-shadow: none !important;
        }

        /* Success Message */
        .success-message {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(76, 175, 80, 0.3);
        }

        .success-message .success-icon {
            font-size: 60px;
            margin-bottom: 20px;
            display: block;
        }

        .success-message h3 {
            margin-bottom: 15px;
            font-size: 24px;
        }

        .success-message p {
            opacity: 0.9;
            margin-bottom: 25px;
        }

        .points-earned {
            background-color: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }

        /* Error Messages */
        .error-message {
            background-color: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .error-message.show {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            margin: -15px 0 0 -15px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Recent Checkins */
        .recent-checkins {
            margin-top: 40px;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .recent-checkins h3 {
            color: #2E7D32;
            margin-bottom: 20px;
            font-size: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .checkin-item {
            display: flex;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
        }

        .checkin-item:hover {
            background-color: #f8f9fa;
        }

        .checkin-item:last-child {
            border-bottom: none;
        }

        .checkin-photos {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .checkin-photos img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .checkin-info {
            flex: 1;
        }

        .checkin-museum {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .checkin-time {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .checkin-status {
            color: #888;
            font-size: 14px;
            font-style: italic;
        }

        /* Hidden elements */
        .hidden {
            display: none !important;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .checkin-container {
                padding: 15px;
            }
            
            .step-circle {
                width: 35px;
                height: 35px;
            }
            
            .step-label {
                font-size: 11px;
                max-width: 70px;
            }
            
            .photo-gallery {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }
            
            .nav-btn {
                padding: 10px 20px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container checkin-container">
        <!-- User Header -->
        <div class="user-header">
            <div class="user-info" onclick="toggleUserBox()">
                <div class="user-avatar" id="userAvatar">üë§</div>
                <span id="userName">ƒêang t·∫£i...</span>
            </div>
            <div class="user-box" id="userBox">
                <div class="user-action" onclick="editProfile()">Ch·ªânh s·ª≠a h·ªì s∆°</div>
                <div class="user-action" onclick="logout()">ƒêƒÉng xu·∫•t</div>
            </div>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <h1>üìç Check-in B·∫£o t√†ng</h1>
            <p>Kh√°m ph√° v√† chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n</p>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step">
                <div class="step-circle active" id="step1Circle">1</div>
                <div class="step-label">Ch·ªçn b·∫£o t√†ng</div>
            </div>
            <div class="step-line" id="line1"></div>
            <div class="step">
                <div class="step-circle" id="step2Circle">2</div>
                <div class="step-label">X√°c minh v·ªã tr√≠</div>
            </div>
            <div class="step-line" id="line2"></div>
            <div class="step">
                <div class="step-circle" id="step3Circle">3</div>
                <div class="step-label">Ch·ª•p ·∫£nh</div>
            </div>
            <div class="step-line" id="line3"></div>
            <div class="step">
                <div class="step-circle" id="step4Circle">4</div>
                <div class="step-label">Chia s·∫ª</div>
            </div>
        </div>

        <!-- Step 1: Museum Selection -->
        <div class="step-content active" id="step1Content">
            <h3 class="step-title">üèõÔ∏è Ch·ªçn b·∫£o t√†ng ƒë·ªÉ check-in</h3>
            <p class="step-description">Ch·ªçn m·ªôt b·∫£o t√†ng g·∫ßn b·∫°n ƒë·ªÉ b·∫Øt ƒë·∫ßu check-in</p>
            
            <div class="location-status location-loading" id="locationLoading">
                <div class="loading-spinner"></div>
                <div>ƒêang t√¨m b·∫£o t√†ng g·∫ßn b·∫°n...</div>
            </div>

            <div class="nearby-museums hidden" id="nearbyMuseums">
                <!-- Museums will be loaded here -->
            </div>

            <div class="error-message" id="locationError">
                <strong>Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠!</strong>
                <p>Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠ ƒë·ªÉ t√¨m b·∫£o t√†ng g·∫ßn b·∫°n.</p>
                <button class="nav-btn primary" onclick="requestLocation()">Th·ª≠ l·∫°i</button>
            </div>
        </div>

        <!-- Step 2: Location Verification -->
        <div class="step-content" id="step2Content">
            <h3 class="step-title">üìç X√°c minh v·ªã tr√≠</h3>
            <p class="step-description">Ki·ªÉm tra xem b·∫°n c√≥ ƒëang ·ªü g·∫ßn b·∫£o t√†ng kh√¥ng</p>
            
            <div class="location-status location-loading" id="verificationLoading">
                <div class="loading-spinner"></div>
                <div>ƒêang x√°c minh v·ªã tr√≠ c·ªßa b·∫°n...</div>
            </div>

            <div class="hidden" id="locationResult">
                <div class="distance-info">
                    <div class="distance-value" id="distanceValue">-- m</div>
                    <div class="distance-status" id="distanceStatus">Kho·∫£ng c√°ch ƒë·∫øn b·∫£o t√†ng</div>
                </div>

                <div class="map-container">
                    <div id="locationMap"></div>
                </div>
            </div>

            <div class="error-message" id="verificationError">
                <!-- Error messages will appear here -->
            </div>
        </div>

        <!-- Step 3: Photo Upload -->
        <div class="step-content" id="step3Content">
            <h3 class="step-title">üì∏ Ch·ª•p ·∫£nh k·ª∑ ni·ªám</h3>
            <p class="step-description">Ch·ª•p t·ª´ 1-10 ·∫£nh ƒë·ªÉ l∆∞u l·∫°i kho·∫£nh kh·∫Øc ƒë√°ng nh·ªõ</p>
            
            <div class="photo-upload-section">
                <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
                <button class="photo-upload-btn" onclick="document.getElementById('photoInput').click()">
                    üì∑ Ch·ªçn ·∫£nh
                </button>
                <button class="photo-upload-btn" onclick="takePhoto()">
                    üì± Ch·ª•p ·∫£nh
                </button>
            </div>

            <div class="photo-gallery" id="photoGallery">
                <!-- Photos will be displayed here -->
            </div>

            <div class="photo-count" id="photoCount">Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn</div>

            <div class="error-message" id="photoError">
                <!-- Photo error messages -->
            </div>
        </div>

        <!-- Step 4: Status & Privacy -->
        <div class="step-content" id="step4Content">
            <h3 class="step-title">‚ú® Chia s·∫ª tr·∫£i nghi·ªám</h3>
            <p class="step-description">Th√™m tr·∫°ng th√°i v√† ch·ªçn quy·ªÅn ri√™ng t∆∞ cho b√†i ƒëƒÉng</p>
            
            <div class="status-input-section">
                <label for="statusInput">Tr·∫°ng th√°i c·ªßa b·∫°n:</label>
                <textarea 
                    id="statusInput" 
                    class="status-textarea" 
                    placeholder="Chia s·∫ª c·∫£m x√∫c v√† tr·∫£i nghi·ªám c·ªßa b·∫°n t·∫°i b·∫£o t√†ng..."
                ></textarea>
                
                <div class="status-templates" id="statusTemplates">
                    <!-- Status templates will be generated here -->
                </div>
            </div>

            <div class="privacy-section">
                <label for="privacySelect">Quy·ªÅn ri√™ng t∆∞:</label>
                <select id="privacySelect" class="privacy-select">
                    <option value="public">üåç C√¥ng khai - M·ªçi ng∆∞·ªùi c√≥ th·ªÉ xem</option>
                    <option value="friends">üë• Ch·ªâ b·∫°n b√® - Ch·ªâ b·∫°n b√® c√≥ th·ªÉ xem</option>
                    <option value="private">üîí Ri√™ng t∆∞ - Ch·ªâ b·∫°n c√≥ th·ªÉ xem</option>
                </select>
            </div>

            <div class="error-message" id="statusError">
                <!-- Status error messages -->
            </div>
        </div>

        <!-- Success Message -->
        <div class="step-content" id="successContent">
            <div class="success-message">
                <span class="success-icon">üéâ</span>
                <h3>Check-in th√†nh c√¥ng!</h3>
                <p>B·∫°n ƒë√£ check-in th√†nh c√¥ng t·∫°i <span id="successMuseumName"></span></p>
                <div class="points-earned" id="pointsEarned">
                    +50 ƒëi·ªÉm
                </div>
                <button class="nav-btn primary" onclick="finishCheckin()">
                    üè† V·ªÅ trang ch√≠nh
                </button>
                <button class="nav-btn secondary" onclick="startNewCheckin()">
                    üìç Check-in kh√°c
                </button>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="step-navigation" id="stepNavigation">
            <button class="nav-btn secondary" id="prevBtn" onclick="previousStep()">
                ‚Üê Quay l·∫°i
            </button>
            <button class="nav-btn primary" id="nextBtn" onclick="nextStep()">
                Ti·∫øp t·ª•c ‚Üí
            </button>
        </div>

        <!-- Recent Check-ins -->
        <div class="recent-checkins">
            <h3>Check-in g·∫ßn ƒë√¢y</h3>
            <div id="recentCheckins">
                <div class="loading-spinner" style="margin: 20px auto;"></div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item" onclick="navigateToPage('home')">
            <div class="nav-icon">üè†</div>
            <div class="nav-label">Home</div>
        </div>
        <div class="nav-item" onclick="navigateToPage('map')">
            <div class="nav-icon">üó∫Ô∏è</div>
            <div class="nav-label">Map</div>
        </div>
        <div class="nav-item active" onclick="navigateToPage('checkin')">
            <div class="nav-icon">üìç</div>
            <div class="nav-label">Check-in</div>
        </div>
        <div class="nav-item" onclick="navigateToPage('leaderboard')">
            <div class="nav-icon">üèÜ</div>
            <div class="nav-label">B·∫£ng x·∫øp h·∫°ng</div>
        </div>
        <div class="nav-item" onclick="navigateToPage('profile')">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">Profile</div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 1;
        let checkinData = {
            museumId: null,
            museumName: '',
            userLatitude: null,
            userLongitude: null,
            museumLatitude: null,
            museumLongitude: null,
            photos: [],
            status: '',
            privacy: 'public',
            distance: null
        };
        let locationMap = null;
        let userMarker = null;
        let museumMarker = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadUserInfo();
            loadRecentCheckins();
            requestLocation();
            setupEventListeners();
        });

        // Setup event listeners
        function setupEventListeners() {
            // Photo input change
            document.getElementById('photoInput').addEventListener('change', handlePhotoSelect);
            
            // Status templates click
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('status-template')) {
                    selectStatusTemplate(e.target.textContent);
                }
            });
        }

        // Navigation functions
        function toggleUserBox() {
            const userBox = document.getElementById('userBox');
            userBox.classList.toggle('active');
        }

        function editProfile() {
            window.location.href = 'profile.html';
        }

        function logout() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')) {
                window.location.href = 'logout.php';
            }
        }

        function navigateToPage(page) {
            const pages = {
                'home': 'index.php',
                'map': 'map.html',
                'checkin': 'checkin.html',
                'leaderboard': 'leaderboard.html',
                'profile': 'profile.html'
            };
            
            if (pages[page]) {
                window.location.href = pages[page];
            }
        }

        // Step navigation
        function nextStep() {
            if (currentStep < 4) {
                if (validateCurrentStep()) {
                    currentStep++;
                    showStep(currentStep);
                    
                    // Execute step-specific logic
                    switch(currentStep) {
                        case 2:
                            verifyLocation();
                            break;
                        case 4:
                            generateStatusTemplates();
                            break;
                    }
                }
            } else {
                // Final submission
                submitCheckin();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
            }
        }

        function showStep(step) {
            // Hide all step contents
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show current step
            document.getElementById(`step${step}Content`).classList.add('active');
            
            // Update step indicator
            updateStepIndicator(step);
            
            // Update navigation buttons
            updateNavigationButtons(step);
        }

        function updateStepIndicator(step) {
            // Reset all circles
            document.querySelectorAll('.step-circle').forEach((circle, index) => {
                circle.classList.remove('active', 'completed');
                if (index + 1 < step) {
                    circle.classList.add('completed');
                } else if (index + 1 === step) {
                    circle.classList.add('active');
                }
            });
            
            // Update lines
            document.querySelectorAll('.step-line').forEach((line, index) => {
                line.classList.remove('active');
                if (index + 1 < step) {
                    line.classList.add('active');
                }
            });
        }

        function updateNavigationButtons(step) {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const navigation = document.getElementById('stepNavigation');
            
            // Show/hide navigation for success step
            if (step === 5) {
                navigation.classList.add('hidden');
                return;
            } else {
                navigation.classList.remove('hidden');
            }
            
            // Previous button
            prevBtn.style.display = step === 1 ? 'none' : 'inline-block';
            
            // Next button text
            if (step === 4) {
                nextBtn.textContent = 'Ho√†n t·∫•t Check-in üéâ';
                nextBtn.classList.add('submit-btn');
            } else {
                nextBtn.textContent = 'Ti·∫øp t·ª•c ‚Üí';
                nextBtn.classList.remove('submit-btn');
            }
        }

        function validateCurrentStep() {
            switch(currentStep) {
                case 1:
                    if (!checkinData.museumId) {
                        showError('Vui l√≤ng ch·ªçn m·ªôt b·∫£o t√†ng ƒë·ªÉ check-in.', 'locationError');
                        return false;
                    }
                    return true;
                    
                case 2:
                    if (checkinData.distance === null || checkinData.distance > 50) {
                        showError('B·∫°n c·∫ßn ·ªü g·∫ßn b·∫£o t√†ng h∆°n ƒë·ªÉ c√≥ th·ªÉ check-in (trong ph·∫°m vi 50m).', 'verificationError');
                        return false;
                    }
                    return true;
                    
                case 3:
                    if (checkinData.photos.length === 0) {
                        showError('Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 ·∫£nh ƒë·ªÉ check-in.', 'photoError');
                        return false;
                    }
                    return true;
                    
                case 4:
                    // Status is optional, just get the values
                    checkinData.status = document.getElementById('statusInput').value.trim();
                    checkinData.privacy = document.getElementById('privacySelect').value;
                    return true;
                    
                default:
                    return true;
            }
        }

        // Location functions
        function requestLocation() {
            const loadingElement = document.getElementById('locationLoading');
            const errorElement = document.getElementById('locationError');
            
            loadingElement.classList.remove('hidden');
            errorElement.classList.remove('show');
            
            if (!navigator.geolocation) {
                showError('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã GPS.', 'locationError');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                position => {
                    checkinData.userLatitude = position.coords.latitude;
                    checkinData.userLongitude = position.coords.longitude;
                    findNearbyMuseums();
                },
                error => {
                    let errorMessage = 'Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠ c·ªßa b·∫°n. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Th√¥ng tin v·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Y√™u c·∫ßu x√°c ƒë·ªãnh v·ªã tr√≠ ƒë√£ h·∫øt th·ªùi gian.';
                            break;
                        default:
                            errorMessage += 'ƒê√£ x·∫£y ra l·ªói kh√¥ng x√°c ƒë·ªãnh.';
                            break;
                    }
                    showError(errorMessage, 'locationError');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }

        async function findNearbyMuseums() {
            try {
                const response = await fetch('getNearbyMuseums.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `latitude=${checkinData.userLatitude}&longitude=${checkinData.userLongitude}`
                });

                const data = await response.json();
                
                if (data.success && data.museums && data.museums.length > 0) {
                    displayNearbyMuseums(data.museums);
                } else {
                    showError('Kh√¥ng t√¨m th·∫•y b·∫£o t√†ng n√†o g·∫ßn v·ªã tr√≠ c·ªßa b·∫°n.', 'locationError');
                }
            } catch (error) {
                console.error('Error finding nearby museums:', error);
                showError('ƒê√£ x·∫£y ra l·ªói khi t√¨m b·∫£o t√†ng. Vui l√≤ng th·ª≠ l·∫°i.', 'locationError');
            }
        }

        function displayNearbyMuseums(museums) {
            const loadingElement = document.getElementById('locationLoading');
            const museumsContainer = document.getElementById('nearbyMuseums');
            
            loadingElement.classList.add('hidden');
            museumsContainer.classList.remove('hidden');
            
            museumsContainer.innerHTML = '';
            
            museums.forEach(museum => {
                const distance = calculateDistance(
                    checkinData.userLatitude, 
                    checkinData.userLongitude,
                    parseFloat(museum.Latitude),
                    parseFloat(museum.Longitude)
                );
                
                const museumCard = document.createElement('div');
                museumCard.className = 'museum-card';
                museumCard.onclick = () => selectMuseum(museum, distance);
                
                museumCard.innerHTML = `
                    <div class="museum-name">${museum.MuseumName}</div>
                    <div class="museum-address">${museum.Address}</div>
                    <div class="museum-distance">${Math.round(distance)}m t·ª´ v·ªã tr√≠ c·ªßa b·∫°n</div>
                    <div class="museum-checkin-info">
                        <div>ƒêi·ªÉm th∆∞·ªüng: ${museum.CheckinPoints || 50} ƒëi·ªÉm</div>
                        <div>C√≤n l·∫°i h√¥m nay: <span class="remaining-checkins">ƒêang ki·ªÉm tra...</span></div>
                    </div>
                `;
                
                museumsContainer.appendChild(museumCard);
                
                // Check remaining checkins for this museum
                checkRemainingCheckins(museum.MuseumID, museumCard);
            });
        }

        async function checkRemainingCheckins(museumId, museumCard) {
            try {
                const response = await fetch('checkCheckinEligibility.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `museumId=${museumId}`
                });

                const data = await response.json();
                const remainingSpan = museumCard.querySelector('.remaining-checkins');
                
                if (data.success) {
                    if (data.canCheckin) {
                        remainingSpan.textContent = `${data.remainingToday} l·∫ßn`;
                        remainingSpan.style.color = '#4CAF50';
                    } else {
                        remainingSpan.textContent = data.message;
                        remainingSpan.style.color = '#f44336';
                        museumCard.style.opacity = '0.6';
                        museumCard.style.pointerEvents = 'none';
                    }
                } else {
                    remainingSpan.textContent = 'Kh√¥ng th·ªÉ ki·ªÉm tra';
                    remainingSpan.style.color = '#666';
                }
            } catch (error) {
                console.error('Error checking checkin eligibility:', error);
            }
        }

        function selectMuseum(museum, distance) {
            // Remove previous selection
            document.querySelectorAll('.museum-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Mark as selected
            event.currentTarget.classList.add('selected');
            
            // Store museum data
            checkinData.museumId = museum.MuseumID;
            checkinData.museumName = museum.MuseumName;
            checkinData.museumLatitude = parseFloat(museum.Latitude);
            checkinData.museumLongitude = parseFloat(museum.Longitude);
            checkinData.distance = distance;
        }

        async function verifyLocation() {
            const loadingElement = document.getElementById('verificationLoading');
            const resultElement = document.getElementById('locationResult');
            const errorElement = document.getElementById('verificationError');
            
            loadingElement.classList.remove('hidden');
            resultElement.classList.add('hidden');
            errorElement.classList.remove('show');
            
            try {
                // Get fresh location
                navigator.geolocation.getCurrentPosition(
                    position => {
                        const newDistance = calculateDistance(
                            position.coords.latitude,
                            position.coords.longitude,
                            checkinData.museumLatitude,
                            checkinData.museumLongitude
                        );
                        
                        checkinData.userLatitude = position.coords.latitude;
                        checkinData.userLongitude = position.coords.longitude;
                        checkinData.distance = newDistance;
                        
                        displayLocationResult(newDistance);
                    },
                    error => {
                        showError('Kh√¥ng th·ªÉ x√°c ƒë·ªãnh v·ªã tr√≠ hi·ªán t·∫°i. Vui l√≤ng th·ª≠ l·∫°i.', 'verificationError');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } catch (error) {
                showError('ƒê√£ x·∫£y ra l·ªói khi x√°c minh v·ªã tr√≠.', 'verificationError');
            }
        }

        function displayLocationResult(distance) {
            const loadingElement = document.getElementById('verificationLoading');
            const resultElement = document.getElementById('locationResult');
            const distanceValueElement = document.getElementById('distanceValue');
            const distanceStatusElement = document.getElementById('distanceStatus');
            
            loadingElement.classList.add('hidden');
            resultElement.classList.remove('hidden');
            
            distanceValueElement.textContent = Math.round(distance) + 'm';
            
            if (distance <= 50) {
                distanceStatusElement.textContent = 'B·∫°n ƒëang ·ªü trong ph·∫°m vi check-in ‚úÖ';
                distanceStatusElement.style.color = '#4CAF50';
                distanceValueElement.style.color = '#4CAF50';
            } else {
                distanceStatusElement.textContent = 'B·∫°n c·∫ßn ƒë·∫øn g·∫ßn b·∫£o t√†ng h∆°n ‚ùå';
                distanceStatusElement.style.color = '#f44336';
                distanceValueElement.style.color = '#f44336';
            }
            
            // Initialize map
            initLocationMap();
        }

        function initLocationMap() {
            const mapContainer = document.getElementById('locationMap');
            
            if (locationMap) {
                locationMap.remove();
            }
            
            locationMap = L.map('locationMap').setView([
                (checkinData.userLatitude + checkinData.museumLatitude) / 2,
                (checkinData.userLongitude + checkinData.museumLongitude) / 2
            ], 16);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(locationMap);
            
            // Add user marker
            userMarker = L.marker([checkinData.userLatitude, checkinData.userLongitude], {
                icon: L.divIcon({
                    html: 'üìç',
                    iconSize: [30, 30],
                    className: 'user-marker'
                })
            }).addTo(locationMap);
            userMarker.bindPopup('V·ªã tr√≠ c·ªßa b·∫°n');
            
            // Add museum marker
            museumMarker = L.marker([checkinData.museumLatitude, checkinData.museumLongitude], {
                icon: L.divIcon({
                    html: 'üèõÔ∏è',
                    iconSize: [30, 30],
                    className: 'museum-marker'
                })
            }).addTo(locationMap);
            museumMarker.bindPopup(checkinData.museumName);
            
            // Draw line between user and museum
            const line = L.polyline([
                [checkinData.userLatitude, checkinData.userLongitude],
                [checkinData.museumLatitude, checkinData.museumLongitude]
            ], {
                color: checkinData.distance <= 50 ? '#4CAF50' : '#f44336',
                weight: 3,
                opacity: 0.7
            }).addTo(locationMap);
            
            // Fit bounds to show both markers
            const group = new L.featureGroup([userMarker, museumMarker]);
            locationMap.fitBounds(group.getBounds().pad(0.1));
        }

        // Photo handling
        function handlePhotoSelect(event) {
            const files = Array.from(event.target.files);
            
            if (checkinData.photos.length + files.length > 10) {
                showError('B·∫°n ch·ªâ c√≥ th·ªÉ t·∫£i l√™n t·ªëi ƒëa 10 ·∫£nh.', 'photoError');
                return;
            }
            
            files.forEach(async (file) => {
                if (file.type.startsWith('image/')) {
                    try {
                        const optimizedFile = await optimizeImage(file);
                        checkinData.photos.push(optimizedFile);
                        displayPhotos();
                    } catch (error) {
                        console.error('Error optimizing image:', error);
                        showError('Kh√¥ng th·ªÉ x·ª≠ l√Ω ·∫£nh. Vui l√≤ng th·ª≠ ·∫£nh kh√°c.', 'photoError');
                    }
                }
            });
        }

        function takePhoto() {
            // For mobile devices, this will open camera
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.capture = 'environment';
            input.onchange = handlePhotoSelect;
            input.click();
        }

        function displayPhotos() {
            const gallery = document.getElementById('photoGallery');
            const counter = document.getElementById('photoCount');
            
            gallery.innerHTML = '';
            
            checkinData.photos.forEach((photo, index) => {
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                
                const img = document.createElement('img');
                img.src = URL.createObjectURL(photo);
                img.alt = `·∫¢nh ${index + 1}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'photo-remove';
                removeBtn.innerHTML = '√ó';
                removeBtn.onclick = () => removePhoto(index);
                
                photoItem.appendChild(img);
                photoItem.appendChild(removeBtn);
                gallery.appendChild(photoItem);
            });
            
            counter.textContent = `${checkinData.photos.length}/10 ·∫£nh ƒë√£ ch·ªçn`;
        }

        function removePhoto(index) {
            checkinData.photos.splice(index, 1);
            displayPhotos();
        }

        async function optimizeImage(file) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions (max 1200px)
                    let { width, height } = img;
                    const maxSize = 1200;
                    
                    if (width > height && width > maxSize) {
                        height = (height * maxSize) / width;
                        width = maxSize;
                    } else if (height > maxSize) {
                        width = (width * maxSize) / height;
                        height = maxSize;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    canvas.toBlob(resolve, 'image/jpeg', 0.8);
                };
                
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        }

        // Status templates
        function generateStatusTemplates() {
            const templatesContainer = document.getElementById('statusTemplates');
            const templates = [
                `ƒêang kh√°m ph√° ${checkinData.museumName} üèõÔ∏è`,
                `·∫§n t∆∞·ª£ng v·ªõi c√°c hi·ªán v·∫≠t t·∫°i ${checkinData.museumName}`,
                `H·ªçc h·ªèi ƒë∆∞·ª£c nhi·ªÅu ƒëi·ªÅu th√∫ v·ªã t·∫°i ƒë√¢y`,
                `M·ªôt ng√†y tuy·ªát v·ªùi t·∫°i b·∫£o t√†ng`,
                `Kh√°m ph√° l·ªãch s·ª≠ v√† vƒÉn h√≥a Vi·ªát Nam`,
                `Tr·∫£i nghi·ªám ƒë√°ng nh·ªõ t·∫°i ${checkinData.museumName}`
            ];
            
            templatesContainer.innerHTML = '';
            
            templates.forEach(template => {
                const templateBtn = document.createElement('div');
                templateBtn.className = 'status-template';
                templateBtn.textContent = template;
                templatesContainer.appendChild(templateBtn);
            });
        }

        function selectStatusTemplate(template) {
            document.getElementById('statusInput').value = template;
        }

        // Submit checkin
        async function submitCheckin() {
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.disabled = true;
            nextBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
            
            try {
                // Validate final data
                if (!validateCurrentStep()) {
                    nextBtn.disabled = false;
                    nextBtn.textContent = 'Ho√†n t·∫•t Check-in üéâ';
                    return;
                }
                
                // Upload photos first
                const photoUrls = await uploadPhotos();
                
                // Create checkin
                const checkinResponse = await fetch('createCheckinPost.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        museumId: checkinData.museumId,
                        latitude: checkinData.userLatitude,
                        longitude: checkinData.userLongitude,
                        status: checkinData.status,
                        privacy: checkinData.privacy,
                        photos: photoUrls
                    })
                });
                
                const result = await checkinResponse.json();
                
                if (result.success) {
                    showSuccessMessage(result.points || 50);
                } else {
                    throw new Error(result.message || 'ƒê√£ x·∫£y ra l·ªói khi check-in');
                }
                
            } catch (error) {
                console.error('Error submitting checkin:', error);
                showError('ƒê√£ x·∫£y ra l·ªói khi check-in. Vui l√≤ng th·ª≠ l·∫°i.', 'statusError');
                nextBtn.disabled = false;
                nextBtn.textContent = 'Ho√†n t·∫•t Check-in üéâ';
            }
        }

        async function uploadPhotos() {
            const photoUrls = [];
            
            for (let i = 0; i < checkinData.photos.length; i++) {
                const formData = new FormData();
                formData.append('photo', checkinData.photos[i]);
                formData.append('type', 'checkin');
                
                try {
                    const response = await fetch('uploadPhoto.php', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        photoUrls.push(result.photoPath);
                    } else {
                        throw new Error('Upload failed');
                    }
                } catch (error) {
                    console.error('Error uploading photo:', error);
                    throw new Error('Kh√¥ng th·ªÉ t·∫£i l√™n ·∫£nh');
                }
            }
            
            return photoUrls;
        }

        function showSuccessMessage(points) {
            currentStep = 5;
            showStep(5);
            
            document.getElementById('successMuseumName').textContent = checkinData.museumName;
            document.getElementById('pointsEarned').textContent = `+${points} ƒëi·ªÉm`;
            
            // Reload recent checkins
            loadRecentCheckins();
        }

        // Utility functions
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c;
        }

        function showError(message, elementId) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.innerHTML = `<strong>‚ö†Ô∏è L·ªói:</strong> ${message}`;
                errorElement.classList.add('show');
                
                // Auto hide after 8 seconds
                setTimeout(() => {
                    errorElement.classList.remove('show');
                }, 8000);
            }
        }

        function finishCheckin() {
            // Reset everything and go back to step 1
            checkinData = {
                museumId: null,
                museumName: '',
                userLatitude: null,
                userLongitude: null,
                museumLatitude: null,
                museumLongitude: null,
                photos: [],
                status: '',
                privacy: 'public',
                distance: null
            };
            
            currentStep = 1;
            showStep(1);
            
            // Clear forms
            document.getElementById('photoInput').value = '';
            document.getElementById('statusInput').value = '';
            document.getElementById('privacySelect').value = 'public';
            document.getElementById('photoGallery').innerHTML = '';
            document.getElementById('photoCount').textContent = 'Ch∆∞a c√≥ ·∫£nh n√†o ƒë∆∞·ª£c ch·ªçn';
            
            // Request location again
            requestLocation();
        }

        function startNewCheckin() {
            finishCheckin();
        }

        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch('getUserInfo.php');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('userName').textContent = data.user.FullName || 'Ng∆∞·ªùi d√πng';
                    if (data.user.Avatar) {
                        document.getElementById('userAvatar').style.backgroundImage = `url(${data.user.Avatar})`;
                        document.getElementById('userAvatar').textContent = '';
                    }
                }
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Load recent checkins
        async function loadRecentCheckins() {
            try {
                const response = await fetch('getRecentCheckins.php');
                const data = await response.json();
                
                const container = document.getElementById('recentCheckins');
                
                if (data.success && data.checkins && data.checkins.length > 0) {
                    container.innerHTML = '';
                    
                    data.checkins.forEach(checkin => {
                        const checkinItem = document.createElement('div');
                        checkinItem.className = 'checkin-item';
                        
                        const photoUrl = checkin.photos && checkin.photos.length > 0 
                            ? checkin.photos[0] 
                            : 'uploads/checkins/default.png';
                        
                        checkinItem.innerHTML = `
                            <div class="checkin-photos">
                                <img src="${photoUrl}" alt="Check-in photo" onerror="this.src='uploads/checkins/default.png'">
                            </div>
                            <div class="checkin-info">
                                <div class="checkin-museum">${checkin.MuseumName}</div>
                                <div class="checkin-time">${formatDate(checkin.CheckinTime)}</div>
                                ${checkin.Status ? `<div class="checkin-status">${checkin.Status}</div>` : ''}
                            </div>
                        `;
                        
                        container.appendChild(checkinItem);
                    });
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Ch∆∞a c√≥ check-in n√†o g·∫ßn ƒë√¢y</p>';
                }
            } catch (error) {
                console.error('Error loading recent checkins:', error);
                document.getElementById('recentCheckins').innerHTML = 
                    '<p style="text-align: center; color: #f44336; padding: 20px;">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ check-in</p>';
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'V·ª´a xong';
            if (minutes < 60) return `${minutes} ph√∫t tr∆∞·ªõc`;
            if (hours < 24) return `${hours} gi·ªù tr∆∞·ªõc`;
            if (days < 7) return `${days} ng√†y tr∆∞·ªõc`;
            
            return date.toLocaleDateString('vi-VN');
        }
    </script>
</body>
</html>